
@{
    ViewBag.Title = "TrackParts";
    Layout = "~/Areas/PartsLocal/Views/Shared/_PartlocalLayout.cshtml";
}


<div class="GridContainer">
    <div class="GridColumn">
        <p style="margin: 1em 0 .5em; font-weight: 600; color: #2C3E50;"><i class="fa-solid fa-barcode"></i>  Scan Barcode or Type Manually   </p>
        <div class="search-section">
            <div class="search-container">

                <input type="text" id="searchInput" style="border-color: hsl(209, 80%, 50%); box-shadow: 0 0 0 0.1rem rgba(100, 128, 253, 0.25); "  placeholder="Enter part number to search (e.g., 002886060-01)" autocomplete="off">
                <button id="searchButton"><i class="fa-solid fa-magnifying-glass"></i> Search Parts</button>
                <button id="clearSearch"><i class="fa-solid fa-xmark"></i> Clear Search</button>
            </div>
        </div>


        <div class="grid-container" id="partsGrid">
            <!-- Grid cells will be generated by JavaScript -->
        </div>

        <div id="resultsInfo" class="results-info" style="display: none;">
            <!-- Search results info will appear here -->
        </div>


        <div class="results-section" id="resultsSection" style="display: none;">
            <h3 id="resultsTitle">Search Results</h3>
            <table class="results-table" id="resultsTable">
                <thead>
                    <tr>
                        <th style="text-align: center;">Area</th>
                        <th style="text-align: center;">Record ID</th>
                        <th style="text-align: center;">Part Number</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
        </div>

        <div class="instructions">
            <h3>How to Use This System <i class="fa-solid fa-circle-info"></i></h3>
            <p>1. <strong>Search Parts:</strong> Enter a part number in the search box or Use the Barcode scan highlight matching locations</p>
            <p>2. <strong>Select Location:</strong> Click on any location to select it and view its details</p>
            <p>3. <strong>Clear Search:</strong> Click "Clear Search" to remove all highlights from the grid</p>
        </div>
    </div>


    <div class="GridColumnInfo">
        <h2>Product Information</h2>

        <div class="ProductDetails">
            <div class="ProductDetails__content">
                <div class="ProductDetails__Text">
                    <span>Part number :</span>
                    <p id="partText">--NA--</p>
                </div>
            </div>

            <div class="ProductDetails__content">
                <div class="ProductDetails__Text">
                    <span>Model name :</span>
                    <p id="Model">--NA--</p>
                </div>
            </div>
           
            <div class="ProductDetails__content">
                <div class="ProductDetails__Text">
                    <span>Quantity :</span>
                    <p id="Quantity">--NA--</p>
                </div>

            </div>
        </div>
        <hr />
        <div class="PartslistAction">



            <div class="MainVerifyContainer">
                <label>Required Part number:   <i class="fa-solid fa-barcode"></i></label><br />
                <input type="text" class="form-control" id="RequireInput" placeholder="Enter the Required Partnumber" />
                <br />
                <label>Verify status : <i class="fa-regular fa-circle-check"></i></label><br />
                <div class="VerifyContainer">
                    <span id="VerifyIcon"><i class="fa-solid fa-circle-xmark"></i></span>
                    <span id="VerifyStats">Not Good</span>
                </div>

                <label>Select a Transaction  :  </label>

                <hr style="margin: 0;" />
                <div class="flex_align TransactionWrap">
                    <button id="OpenOutbtn" disabled><i class="fa-solid fa-box-open"></i>  Out (Issued)</button>
                    <button id="OpenInbtn" disabled><i class="fa-solid fa-box"></i> IN  (Receive)</button>
                </div>
            </div>


        </div>


    </div>
</div>


@*=================================================================================*@
@*=========================== EDIT MASTERLIST PARTS ===============================*@
@*=================================================================================*@
<div class="modal fade modal-xl" id="OpenStorageModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-body modalwrap">
                <div class="custom_modal_header">
                    <h5>Shelf  Code :  <span id="letterdisplay"></span> </h5>

                    <button type="button" class="btn btn-light  close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>

                <table>
                    <tr>
                        <th align="left">PartNo</th>
                        <th align="left">PartName</th>
                        <th align="left">Quantity</th>
                        <th align="left">Front Image</th>
                        <th align="left">Back Image</th>
                    </tr>
                    <tbody id="StorageBody">
                    </tbody>
                </table>

            </div>


        </div>
    </div>
</div>




@*=================================================================================*@
@*=========================== SHOP ORDER IN =====================================*@
@*=================================================================================*@
<div class="modal fade modal-lg" id="ShowShopOrderIN" tabindex="-1" role="dialog" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">

            <div class="modal-body modalwrap">
                <div class="custom_modal_header">
                    <h5>Shop Order monitoring Details (IN)</h5>

                    <button type="button" class="btn btn-light  close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>

                <hr />


                <div class="stepper" id="validationStepper">
                    <ol class="stepper-steps">
                        <li class="stepper-step active" data-step="1">
                            <div class="stepper-step-indicator">1</div>
                            <div class="stepper-step-label">Enter Quantity</div>
                        </li>
                        <li class="stepper-step" data-step="2">
                            <div class="stepper-step-indicator">2</div>
                            <div class="stepper-step-label">Shop Order(IN)</div>
                        </li>
                    </ol>




                    <div class="stepper-content">
                        <!-- Step 1: Account Information -->
                        <div class="stepper-pane active" id="validation-step-1">
                            <div class="ModalWrapper">
                                <label for="QuantityIN" class="form-label">Enter Quantity:</label>
                                <input type="number" class="form-control" id="QuantityIN" name="QuantityIN" required>
                            </div>        
                        </div>

                        <!-- Step 2: Profile Information -->
                        <div class="stepper-pane" id="validation-step-2">
                            <div class="ModalWrapper">
                                <div class="pane-header">
                                    <h3>Shop Order Details</h3>
                                    <p>Provide the shop order information for monitoring purposes.</p>
                                </div>

                                <div class="shop-order-form">
                                    <form id="ShopOrderInForm">
                                        <div class="form-row">
                                            <div class="form-col">
                                                <div class="form-group">
                                                    <label for="inputBy" class="form-label">
                                                        <i class="fas fa-user"></i> Input By
                                                    </label>
                                                    <input type="text" class="form-control" id="inputBy" name="Remarks" placeholder="Enter your Employee ID" required>
                                                    <small style="color: #0094ff;">Use barcode scan or type Manually</small>
                                                </div>
                                            </div>

                                            <div class="form-col">
                                                <div class="form-group">
                                                    <label for="rotorOrder" class="form-label">
                                                        <i class="fas fa-cogs"></i> Rotor Shop Order
                                                    </label>
                                                    <input type="text" class="form-control" id="rotorOrder" name="RotorOrder" placeholder="Enter rotor order number" required>
                                                </div>
                                            </div>
                                        </div>

                                    </form>
                                </div> 

                               
                            </div>       

                               
                         </div>
                    </div>

                    <div class="stepper-actions">
                        <div class="step-indicators">
                            <div class="step-indicator active" data-step="1"></div>
                            <div class="step-indicator" data-step="2"></div>
                        </div>
                        <div class="flex_align">
                            <button class="btn btn-secondary" id="prevBtn" disabled> <i class="fas fa-arrow-left"></i> Previous</button>
                            <button class="btn btn-primary" id="nextBtn">Next <i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>
                </div>





            </div>

        </div>
    </div>
</div>

@*=================================================================================*@
@*=========================== SHOP ORDER OUT =====================================*@
@*=================================================================================*@
<div class="modal fade modal-lg" id="ShowShopOrderOut" tabindex="-1" role="dialog" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">

            <div class="modal-body modalwrap">
                <div class="custom_modal_header">
                    <h5>Shop Order monitoring Details (OUT)</h5>

                    <button type="button" class="btn btn-light  close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>


                <div class="stepper" id="validationStepperOut">
                    <ol class="stepper-steps">
                        <li class="stepper-step active" data-step="1">
                            <div class="stepper-step-indicator">1</div>
                            <div class="stepper-step-label">Enter Quantity</div>
                        </li>
                        <li class="stepper-step" data-step="2">
                            <div class="stepper-step-indicator">2</div>
                            <div class="stepper-step-label">Shop Order Details</div>
                        </li>
                    </ol>

                    <div class="stepper-content">
                        <!-- Step 1: Quantity Information -->
                        <div class="stepper-pane active" id="validation-out-step-1">
                
                            <div class="ModalWrapper">
                                <label for="QuantityOUT" class="form-label">Quantity to Issue:</label>
                                <input type="number" class="form-control" id="QuantityOUT" name="QuantityOUT" required>
                            </div>
                        </div>

                        <!-- Step 2: Shop Order Out Information -->
                        <div class="stepper-pane" id="validation-out-step-2">
                            <div class="ModalWrapper">
                                <div class="pane-header">
                                    <h3>Shop Order Details</h3>
                                    <p>Complete all required information for the shop order monitoring process. All fields marked with <span style="color: red;">*</span> are required.</p>
                                </div>

                                <div class="shop-order-form">
                                    <form class="row g-3 mb-4" id="ShopOrderOutForm">
                                        <div class="col-md-6">

                                            <label for="PreparedBy" class="form-label">Prepared by: <i class="fa-solid fa-barcode"></i></label>
                                            <input type="text" placeholder="Enter your Name or ID Number" class="form-control" name="Remarks" id="SearchEmployee" required>
                                            <small style="color: #0094ff;">Use barcode scan or type manually</small>

                                        </div>

                                        <div class="col-6">
                                            <label for="RotorShopOrder" class="form-label">Rotor Shop Order:</label>
                                            <input type="text" placeholder="Enter Rotor Shop Order" class="form-control" name="RotorOrder" id="RotorFocus" required>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="FAShopOrder" class="form-label">FA Shop Order:</label>
                                            <input type="text" placeholder="Enter Shop Order" class="form-control" name="ShopOrder" id="FAFocus" required>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="ModelBase" class="form-label">Model Base:</label>
                                            <input type="text" placeholder="Enter Model Base" class="form-control" name="ModelBase" id="ModelFocus" required>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="PlanQuantity" class="form-label">Plan Quantity:</label>
                                            <input type="number" placeholder="Enter Plan Quantity" class="form-control" name="PlanQuantity" id="PlanFocus" required>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="PlanStart" class="form-label">Plan Start:</label>
                                            <input type="date" class="form-control" name="PlanDate" required>
                                        </div>


                                        <div class="col-md-6">
                                            <label for="Status" class="form-label">Status:</label>
                                            <select class="form-control" name="Status" required>
                                                <option value="None">None</option>
                                                <option value="Completely issued">Completely issued</option>
                                                <option value="Partially issued">Partially issued</option>
                                            </select>
                                        </div>


                                        <div class="col-6">
                                            <label for="BushMaterial" class="form-label">Bush Material:</label>
                                            <select class="form-control" name="BushType" required>
                                                <option value="0">None</option>
                                                <option value="1">PB bush</option>
                                                <option value="2">PB free bush</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
        
                            </div>

                        </div>
                     </div>

                    <div class="stepper-actions">
                        <div class="step-indicators">
                            <div class="step-indicator active" data-step="1"></div>
                            <div class="step-indicator" data-step="2"></div>
                        </div>
                        <div>
                           

                            <div class="flex_align">
                                <button class="btn btn-secondary" id="prevBtnOut" disabled> <i class="fas fa-arrow-left"></i> Previous</button>
                                <button class="btn btn-primary" id="nextBtnOut">Next <i class="fas fa-arrow-right"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>







<script>
    const gridContainer = document.getElementById('partsGrid');
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const clearSearchButton = document.getElementById('clearSearch');
    const resultsInfo = document.getElementById('resultsInfo');
    const resultsSection = document.getElementById('resultsSection');
    const resultsBody = document.getElementById('resultsBody');
    const resultsTitle = document.getElementById('resultsTitle');

    let storageList = [];
    let referpartnum;
    let Arealocation;
    let previousCount;


    /* =========================================================
                    GLOBAL VARIABLES
    ========================================================= */
    let currentStep = 1;
    let currentStepOut = 1;
    const totalSteps = 2;

    /* =========================================================
                IN STEPPER ELEMENTS (SCOPED)
    ========================================================= */
    const stepperSteps = document.querySelectorAll('#validationStepper .stepper-step');
    const stepperPanes = document.querySelectorAll('#validationStepper .stepper-pane');
    const stepIndicators = document.querySelectorAll('#validationStepper .step-indicator');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const shopForms = document.getElementById('ShopOrderInForm');
    /* =========================================================
     OUT STEPPER ELEMENTS (SCOPED)
     ========================================================= */
    const stepperStepsOut = document.querySelectorAll('#validationStepperOut .stepper-step');
    const stepperPanesOut = document.querySelectorAll('#validationStepperOut .stepper-pane');
    const stepIndicatorsOut = document.querySelectorAll('#validationStepperOut .step-indicator');
    const prevBtnOut = document.getElementById('prevBtnOut');
    const nextBtnOut = document.getElementById('nextBtnOut');
    const shopFormsOut = document.getElementById('ShopOrderOutForm');


    // RBF Location Codes - All possible locations
    const locationCodes = [
        'RBF21001001',
        'RBF22001001',
        'RBF23001001',
        'RBF24001001',
        'RBF25001001',
        'RBF26001001',
        'RBF27001001',
        'RBF28001001',
        'RBF29001001',
        'RBF2A001001',
        'RBF2B001001',
        'RBF2C001001',
        'RBF2D001001',
        'RBF2E001001',
        'RBF2F001001',
        'RBF2G001001',
        'RBF2H001001',
        'RBF2J001001',
        'RBF2K001001',
        'RBF2L001001',
        'RBF2M001001',
        'RBF2N001001',
        'RBF2P001001'
    ];




   

    const partlocationStorageList = async () => {
        let res = await FetchAuthenticate('@Url.Action("GetStorageData", "PartsLocator")', {});
        if (res && res.Success) {
            //let matchData = res.Data.filter(res => res.Partnumber === "01013699-01");
            //console.log(matchData);
            storageList = res.Data;
            //storageList = res.Data.map(item => ({
            //    ...item,
            //    Area: customAreaMapping(item.Area)
            //}));
            createGrid();
        }
    };

    const customAreaMapping = (areaNumber) => {
        const mapping = {
            1: 'A', 2: 'B', 3: 'C', 4: 'D', 5: 'E',
            6: 'F', 7: 'G', 8: 'H', 9: 'I', 10: 'J',
            11: 'K', 12: 'L', 13: 'M', 14: 'N', 15: 'O',
            16: 'P', 17: 'Q', 18: 'R', 19: 'S', 20: 'T',
            21: 'U'
        };
        return mapping[areaNumber] || areaNumber;
    };

    // Create grid with RBF location codes
    const createGrid = () => {
        gridContainer.innerHTML = '';

        locationCodes.forEach(locationCode => {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            cell.id = `cell-${locationCode}`;
            cell.setAttribute('data-area', locationCode);
            cell.title = locationCode; // Full code on hover

            const labelElement = document.createElement('div');
            labelElement.className = 'cell-label';
            // Display shortened version (last 4 characters)
            labelElement.textContent = locationCode.slice(0, 5);

            // Find part numbers for this location
            const locationItems = storageList.filter(item => item.Area === locationCode);
            const partNumbers = [...new Set(locationItems.map(item => item.Partnumber))];

            const partNumberElement = document.createElement('div');
            partNumberElement.className = 'part-number';
            partNumberElement.id = `part-${locationCode}`;
            partNumberElement.textContent = partNumbers.length > 0 ?
                partNumbers.slice(0, 3).join(', ') + (partNumbers.length > 3 ? '...' : '') :
                '-';

            cell.appendChild(labelElement);
            cell.appendChild(partNumberElement);
            gridContainer.appendChild(cell);

            // Add click event
            cell.addEventListener('click', function () {
                handleLocationClick(locationCode);
            });
        });
    };
    // Handle location click
    const handleLocationClick = (locationCode) => {
        const selectedRecordId = getRecordIdByArea(locationCode);
        if (selectedRecordId !== null) {
            getProductDetails(selectedRecordId);
        } else {
            showLocationDetails(locationCode);
        }
        //console.log(locationCode);
        highlightBoxOnly(locationCode);
    };

    // Show location details in modal
    const showLocationDetails = (locationCode) => {
        $("#letterdisplay").text(locationCode);
        const locationStorage = storageList.filter(res => res.Area === locationCode);
        const container = $("#StorageBody");
        container.empty();

        if (locationStorage.length === 0) {
            container.append(
                `<tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: #6c757d;">
                                <i class="fas fa-box-open" style="font-size: 24px; margin-bottom: 10px; display: block;"></i>
                                No parts stored in this location
                            </td>
                        </tr>`
            );
        } else {
            locationStorage.forEach(res => {
                container.append(
                    `<tr class='Editbtnbutton' id='editButton_${res.RecordID}' >
                                <td>${res.Partnumber}</td>
                                <td>${res.ModelName}</td>
                                <td>${res.Quantity}</td>
                                <td>${res.FrontImage}</td>
                                <td>${res.BackImage}</td>
                            </tr>`
                );
            });
        }

        $("#OpenStorageModal").modal("show");
    };



    // Create grid cells A-U
    //const labels = "ABCDEFGHIJKLMNOPQRSTU".split("");

    // Create grid cells
    //labels.forEach(letter => {
    //    // Create grid cell
    //    //console.log("LETTER " + letter);
    //    const cell = document.createElement('div');
    //    cell.className = 'grid-cell';
    //    cell.id = `cell-${letter}`;
    //    cell.setAttribute('data-area', letter);

    //    const labelElement = document.createElement('div');
    //    labelElement.className = 'cell-label';
    //    labelElement.textContent = letter;

    //    // Find part numbers for this area
    //    const areaItems = storageList.filter(item => item.Area === letter);
    //    const partNumbers = [...new Set(areaItems.map(item => item.Partnumber))];

    //    const partNumberElement = document.createElement('div');
    //    partNumberElement.className = 'part-number';
    //    partNumberElement.id = `part-${letter}`;
    //    partNumberElement.textContent = partNumbers.length > 0 ? partNumbers.join(', ') : '-';

    //    cell.appendChild(labelElement);
    //    cell.appendChild(partNumberElement);
    //    gridContainer.appendChild(cell);

    //    // Add click event to grid cell
    //    cell.addEventListener('click', function () {
    //        const selectedRecordId = getRecordIdByArea(letter);
    //        if (selectedRecordId !== null) {


    //            getProductDetails(selectedRecordId);

    //        } else {
    //            $("#letterdisplay").text(letter);
    //            var letterStorage = storageList.filter(res => res.Area === letter);
    //            const exists = storageList.some(u => u.Area === letter);
    //            const container = $("#StorageBody");
    //            container.empty();

    //            letterStorage.forEach(res => {
    //                container.append(
    //                    `<tr class='Editbtnbutton' id='editButton_${res.RecordID}' >
    //                        <td>${res.Partnumber}</td>
    //                        <td>${res.ModelName}</td>
    //                        <td>${res.Quantity}</td>
    //                        <td>${res.FrontImage}</td>
    //                        <td>${res.BackImage}</td>
    //                    </tr>`
    //                );
    //            });

    //            $("#OpenStorageModal").modal("show");
    //        }

    //        // Highlight only the selected box
    //        highlightBoxOnly(letter);
    //    });
    //});

    // === Show Details ===
    $(document).on("click", ".Editbtnbutton", function (e) {
        e.stopPropagation();
        var rowId = $(this).attr("id");
        var rowIndex = rowId.split("_")[1];
        getProductDetails(rowIndex);
        $("#OpenStorageModal").modal("hide");
    });

    $("#RequireInput").on('keyup', function (e) {
        if (e.key === 'Enter') {
            const val = e.target.value;

            if (val === referpartnum) {
                // Text
                $("#VerifyStats").text("GOOD");

                // Icon -> green check
                $("#VerifyIcon").html('<i class="fa-solid fa-circle-check"></i>');

                // Styling
                $(".VerifyContainer")
                    .removeClass("verify-bad")
                    .addClass("verify-good");

                // Enable buttons
                $("#OpenOutbtn").prop("disabled", false);
                $("#OpenInbtn").prop("disabled", false);

            } else {
                // Text
                $("#VerifyStats").text("NOT GOOD");

                // Icon -> red X
                $("#VerifyIcon").html('<i class="fa-solid fa-circle-xmark"></i>');

                // Styling
                $(".VerifyContainer")
                    .removeClass("verify-good")
                    .addClass("verify-bad");

                // Disable buttons
                $("#OpenOutbtn").prop("disabled", true);
                $("#OpenInbtn").prop("disabled", true);
            }
        }
    });

    $("#OpenOutbtn").on('click', function (e) {
        e.preventDefault();
        $("#ShowShopOrderOut").modal("show");
    });


    $("#OpenInbtn").on('click', function (e) {
        e.preventDefault();
        $("#ShowShopOrderIN").modal("show");
    });

    // Highlight ALL areas found
    function highlightMatchingAreas(matchAreas) {
        document.querySelectorAll(".grid-cell").forEach(cell => {
            const area = cell.getAttribute("data-area");
            cell.classList.toggle("highlighted", matchAreas.includes(area));
            cell.classList.remove("verified"); // reset verification
        });
    }

    function highlightVerifiedArea(area) {
        document.querySelectorAll(".grid-cell").forEach(cell => {
            const isMatch = cell.getAttribute("data-area") === area;
            cell.classList.toggle("verified", isMatch);
            cell.classList.remove("highlighted");
        });
    }

    // Highlight ONLY selected letter
    function highlightBoxOnly(selectedArea) {
        console.log("HERE");
        console.log("DDDD : " + selectedArea);
        document.querySelectorAll(".grid-cell").forEach(cell => {
            console.log("HER2");
            const isActive = cell.getAttribute("data-area") === selectedArea;
            console.log("IsActive : " + isActive);
            cell.classList.toggle("active", isActive);

            // Remove highlighted class when selecting a box
            if (isActive) {
                cell.classList.remove("highlighted");
            }
        });
    }

    // Search functionality
    searchButton.addEventListener('click', function () {
        const searchValue = searchInput.value.trim().toUpperCase();
        resultsInfo.style.display = "none";
        resultsSection.style.display = "none";

        // Clear previous highlights
        clearHighlights();

        if (!searchValue) {
            alert('Please enter a search term.');
            return;
        }

        const matchedItems = storageList.filter(item =>
            item.Partnumber.toUpperCase().includes(searchValue)
        );

        $("#RequireInput").val(searchValue);


        if (matchedItems.length > 0) {
            const matchedAreas = [...new Set(matchedItems.map(item => item.Area))];
            //console.log("MATCHING : " + matchedAreas);
            //highlightMatchingAreas(matchedAreas);

            // ✅ GREEN VERIFIED HIGHLIGHT
            highlightVerifiedArea(matchedAreas);

            // Show results info
            resultsInfo.textContent = `Found ${matchedItems.length} match(es) for "${searchValue}"`;
            resultsInfo.style.display = 'block';

            // Show results table
            resultsTitle.textContent = `Matches for Partnumber: ${searchValue}`;
            resultsBody.innerHTML = '';

            

            matchedItems.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                            <td>${item.Area}</td>
                            <td>${item.RecordID}</td>
                            <td>${item.Partnumber}</td>
                        `;
                resultsBody.appendChild(row);
            });

            resultsSection.style.display = 'block';
        } else {
            alert("Partnumber not found!");
        }
    });

    // Clear search functionality
    clearSearchButton.addEventListener('click', function () {
        searchInput.value = '';
        clearHighlights();
        resultsInfo.style.display = 'none';
        resultsSection.style.display = 'none';
    });

    // Function to clear all highlights
    function clearHighlights() {
        document.querySelectorAll(".grid-cell").forEach(cell => {
            cell.classList.remove("highlighted");
            cell.classList.remove("active");
        });
    }

    // Allow pressing Enter in search input
    searchInput.addEventListener('keyup', function (event) {
        if (event.key === 'Enter') {
            searchButton.click();
        }
    });

    $("#SearchEmployee").on('keyup', function (e) {
        if (e.key === 'Enter') {
            let searchEmp = e.target.value;
            console.log("SEARCH EMPLOYEE " + searchEmp);
            SearchEmployeeInfo(searchEmp, 0);
        }
    });

    $("#inputBy").on('keyup', function (e) {
        if (e.key === 'Enter') {
            let searchEmp = e.target.value;
            SearchEmployeeInfo(searchEmp, 1);
        }
    });

    $("#RotorFocus").on('keyup', function (e) {
        if (e.key === 'Enter') {
            $("#FAFocus").focus();
        }
    });

    $("#FAFocus").on('keyup', function (e) {
        if (e.key === 'Enter') {
            $("#ModelFocus").focus();
        }
    });

    $("#ModelFocus").on('keyup', function (e) {
        if (e.key === 'Enter') {
            $("#PlanFocus").focus();
        }
    });

    async function SearchEmployeeInfo(searchEmp, action) {
        let res = await FetchAuthenticate('@Url.Action("GetEmployeeInfo", "PartsLocator")', { emp: searchEmp });
        if (res && res.Success) {
            console.log(res.Data);
            if (res.Data.length == 0) {
                return;
            }
            let Data = res.Data[0].Fullname;
            if (action === 0) {
                $("#SearchEmployee").val(Data);
                $("#RotorFocus").focus();
            } else {
                $("#inputBy").val(Data);
                $("#rotorOrder").focus();
            }
        }
    }


    /* =========================================================
       IN STEPPER FUNCTIONS
    ========================================================= */
    function updateStepper() {

        stepperSteps.forEach((step, index) => {
            step.classList.toggle('active', index + 1 === currentStep);
            step.classList.toggle('completed', index + 1 < currentStep);
        });

        stepperPanes.forEach((pane, index) => {
            pane.classList.toggle('active', index + 1 === currentStep);
        });

        prevBtn.disabled = currentStep === 1;

        if (currentStep === totalSteps) {
            nextBtn.textContent = 'Finish';
            nextBtn.classList.replace('btn-primary', 'btn-success');
        } else {
            nextBtn.textContent = 'Next';
            nextBtn.classList.replace('btn-success', 'btn-primary');
        }
    }
    /* =========================================================
                    OUT STEPPER FUNCTIONS
========================================================= */
// Update stepper UI for OUT
    function updateStepperOut() {

        stepperStepsOut.forEach((step, index) => {
            step.classList.toggle('active', index + 1 === currentStepOut);
            step.classList.toggle('completed', index + 1 < currentStepOut);
        });

        stepperPanesOut.forEach((pane, index) => {
            pane.classList.toggle('active', index + 1 === currentStepOut);
        });

        prevBtnOut.disabled = currentStepOut === 1;

        if (currentStepOut === totalSteps) {
            nextBtnOut.textContent = 'Finish';
            nextBtnOut.classList.replace('btn-primary', 'btn-success');
        } else {
            nextBtnOut.textContent = 'Next';
            nextBtnOut.classList.replace('btn-success', 'btn-primary');
        }
    }

    /* =========================================================
       IN BUTTON EVENTS
    ========================================================= */
    nextBtn.addEventListener('click', async function () {
        let checkQuan = document.getElementById("QuantityIN").value;

        if (!checkQuan) return;

        if (currentStep < totalSteps) {
            currentStep++;
            updateStepper();
            return;
        }

         // Finish button clicked
         let formData = new FormData(shopForms);
         formData.append("Quantity", parseInt(checkQuan));
         formData.append("TransactionType", 0);
         formData.append("Area", Arealocation);
         formData.append("Partnumber", referpartnum);
         formData.append("PreviousQuantity", previousCount);

         const data = Object.fromEntries(formData);
         let res = await postData('@Url.Action("AddShopOrderIn", "PartsLocator")', data);

         if (res?.Success) {
             Swal.fire({
                 title: "Success",
                 text: 'Shop Order IN completed successfully!',
                 icon: "success",
                 showConfirmButton: false,
                 timer: 1500
             }).then(() => {
                 $("#ShowShopOrderIN").modal("hide");
                 previousCount += parseInt(checkQuan);
                 $("#Quantity").text(previousCount);
                 resetStepperIN();
             });

         }
    });

    prevBtn.addEventListener('click', () => {
        if (currentStep > 1) {
            currentStep--;
            updateStepper();
        }
    });

    /* =========================================================
       OUT BUTTON EVENTS
    ========================================================= */
    nextBtnOut.addEventListener('click', async function () {
        let checkQuan = document.getElementById("QuantityOUT").value;

        if (!checkQuan || checkQuan <= 0) return;

        // 🔒 STOCK VALIDATION
        if (checkQuan > previousCount) {
            Swal.fire({
                icon: "error",
                title: "Invalid Quantity",
                text: `Available stock is only ${previousCount}`,
            });
            return;
        }

        if (currentStepOut < totalSteps) {
            currentStepOut++;
            updateStepperOut();
            return;
        }

          // Finish button clicked
          let formData = new FormData(shopFormsOut);
          formData.append("Quantity", parseInt(checkQuan));
          formData.append("TransactionType", 1); // 1 for OUT
          formData.append("Partnumber", referpartnum);
          formData.append("Area", Arealocation);
          formData.append("PreviousQuantity", previousCount);

          let res = await postData('@Url.Action("AddShopOrderOut", "PartsLocator")', Object.fromEntries(formData));

          if (res?.Success) {
              Swal.fire({
                  title: "Success",
                  text: 'Shop Order OUT completed successfully!',
                  icon: "success",
                  showConfirmButton: false,
                  timer: 1500
              }).then(() => {
                  $("#ShowShopOrderOut").modal("hide");
                  previousCount -= parseInt(checkQuan);
                  $("#Quantity").text(previousCount);
                  resetStepperOUT();
              });
          }
    });

    prevBtnOut.addEventListener('click', function () {
        if (currentStepOut > 1) {
            currentStepOut--;
            updateStepperOut();
        }
    });

    /* =========================================================
       RESET FUNCTIONS
    ========================================================= */
    function resetStepperIN() {
        currentStep = 1;
        document.getElementById("QuantityIN").value = "";
        shopForms.reset();
        stepperPanes.forEach(p => p.classList.remove('active'));
        document.getElementById('validation-step-1').classList.add('active');
        updateStepper();
    }

    function resetStepperOUT() {
        currentStepOut = 1;
        document.getElementById("QuantityOUT").value = "";
        shopFormsOut.reset();
        stepperPanesOut.forEach(p => p.classList.remove('active'));
        document.getElementById('validation-out-step-1').classList.add('active');
        updateStepperOut();
    }







    // ✅ Get only the FIRST RecordID of the selected letter
    function getRecordIdByArea(area) {
        const searchValue = document.getElementById('searchInput').value.trim().toUpperCase();
        const areaItems = storageList.filter(item =>
            item.Area === area && item.Partnumber.toUpperCase() === searchValue
        );
        return areaItems.length > 0 ? areaItems[0].RecordID : null;
    }


     async function getProductDetails(id) {

         let res = await FetchAuthenticate('@Url.Action("GetProductDetails", "PartsLocator")', { RecordID: id });
         if (res && res.Success) {
             referpartnum = res.Data.Partnumber;
             Arealocation = res.Data.Area;
             previousCount = res.Data.Quantity;

             $("#partText").text(referpartnum);
             $("#Model").text(res.Data.ModelName);
             $("#Quantity").text(res.Data.Quantity);

             $("#RequireInput").focus();

         }
     }

    partlocationStorageList();

    /* =========================================================
             MODAL CLOSE RESET
            ========================================================= */
    $('#ShowShopOrderIN').on('hidden.bs.modal', resetStepperIN);
    $('#ShowShopOrderOut').on('hidden.bs.modal', resetStepperOUT);

    $('#ShowShopOrderIN').on('shown.bs.modal', function () {
        setTimeout(() => {
            $('#QuantityIN').focus();
        }, 200);
    });

    $('#ShowShopOrderOut').on('shown.bs.modal', function () {
        setTimeout(() => {
            $('#QuantityOUT').focus();
        }, 200);
    });

    /* =========================================================
            INIT
     ========================================================= */
    updateStepper();
    updateStepperOut();
</script>
