
@{
    ViewBag.Title = "Cleaning";
    Layout = "~/Areas/Circuit/Views/Shared/_MaskLayout.cshtml";
}


<section class="CleaningContainer">
    <!-- Controls Section -->
    <div class="controls-section">
        <div class="control-group">
            <label class="control-label">
                <i class="fas fa-search"></i> Search Partnumber
            </label>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Enter Partnumber ..." autocomplete="off">
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">
                <i class="fas fa-calendar"></i> SMT Line
            </label>
            <select id="SMTLine" class="filter-select">
                <option value="0">-- All Lines --  </option>
                @for (int i = 1; i <= 12; i++)
                {
                    <option value="@i">Line @i</option>
                }
            </select>
        </div>


        <div class="control-group">
            <label class="control-label">
                <i class="fas fa-calendar"></i>Model Type
            </label>
            <select id="ModelSelect" class="filter-select">
                <option value="0">-- All Types --  </option>
                <option value="1">FAN </option>
                <option value="2">UPS </option>
                <option value="3">Servo </option>
            </select>
        </div>

    </div>

    <div style="position: relative; box-shadow: 0 3px 5px rgba(0, 0, 0, 0.08);">
        <!-- Loading Overlay -->
        <div class="loading" id="loading" style="padding: 2em 0; height: 300px;">
            <div class="spinner"></div>
        </div>


        <table>
            <thead>
                <tr>
                    <th>Part number</th>
                    <th>Area</th>
                    <th>SMT </th>
                    <th>Shifts </th>
                    <th>Blocks</th>
                    <th>Model type</th>
                </tr>
            </thead>
            <tbody id="TransactionTable">
            </tbody>
        </table>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState">
            <i class="fas fa-inbox" style="transform:scale(1.8)"></i>
            <h3 id="Errormessage">No Data found</h3>
            <p>Add data to get started</p>
        </div>
    </div>

</section>


<div class="modal fade" id="cleaningStepperModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="cleaningStepperModalLabel">
                    <i class="fas fa-broom me-2"></i> Surface Cleaning Analysis
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- Modal Content -->
            <div class="stepper-container">
                <!-- Steps panel on the left -->
                <div class="steps-panel">
                    <div class="steps-title">Process Steps</div>
                    <div class="steps-list">
                        <div class="step-item active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-info">
                                <div class="step-label">Cleaning Info</div>
                                <div class="step-description">Cleaning details</div>
                            </div>
                        </div>
                        <div class="step-item" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-info">
                                <div class="step-label">Tension Mask</div>
                                <div class="step-description">Configure </div>
                            </div>
                        </div>
                        <div class="step-item" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-info">
                                <div class="step-label">Results</div>
                                <div class="step-description">View analysis </div>
                            </div>
                        </div>
                    </div>

                    <!-- Progress bar -->
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                    </div>

                    <div style="color: #5a7184; font-size: 0.9rem; text-align: center;">
                        <i class="fas fa-info-circle" style="margin-right: 5px;"></i>
                        Click on any step to navigate directly
                    </div>
                </div>

                <!-- Content panel on the right -->
                <div class="content-panel">
                    <!-- Step 1: Cleaning Info -->
                    <div class="step-content active" id="step-1">
                        <div class="step-header">
                            <h2 class="step-title">
                                <i class="fas fa-broom step-icon"></i> Cleaning Information
                            </h2>
                            <p class="step-subtitle">Enter details about the surface and cleaning parameters to begin analysis</p>
                        </div>

                        <div class="step-body">
                            <div class="form-group">
                                <label for="cleaning-solution"> Date of Cleaning </label>
                                <input type="date" id="DateClean" >
                            </div>

                            <div class="form-group">
                                <label for="cleaning-solution"> Time of Cleaning </label>
                                <input type="time" id="DateTime">
                            </div>

                            <div class="form-group">
                                <label for="cleaning-solution"> Pattern</label>
                                <input type="text" id="Pattern" placeholder="Enter a Pattern ">
                            </div>


                            <div class="form-group">
                                <label for="cleaning-solution">Frame</label>
                                <input type="text" id="Frame" placeholder="Enter a Frame">
                            </div>

                        </div>
                    </div>

                    <!-- Step 2: Tension Mask -->
                    <div class="step-content" id="step-2">
                        <div class="step-header">
                            <h2 class="step-title">
                                <i class="fas fa-mask step-icon"></i> Tension Mask Configuration
                            </h2>
                            <p class="step-subtitle">Configure surface tension parameters and masking requirements</p>
                        </div>

                        <div class="step-body">
                            <div class="MaskContainer">
                                <div class="MaskCircle">
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2"
                                           placeholder="1" id="MaskPoint_1" class="MaskPoint" />
                                    <p>Point 1</p>
                                </div>

                                <div class="MaskCircle">
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2"
                                           placeholder="2" id="MaskPoint_2" class="MaskPoint" />
                                    <p>Point 2</p>
                                </div>

                                <div class="MaskCircle">
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2"
                                           placeholder="4" id="MaskPoint_4" class="MaskPoint" />
                                    <p>Point 4</p>
                                </div>

                                <div class="MaskCircle">
                                    <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="2"
                                           placeholder="3" id="MaskPoint_3" class="MaskPoint" />
                                    <p>Point 3</p>
                                </div>
                            </div>

                           
                        </div>
                    </div>

                    <!-- Step 3: Results -->
                    <div class="step-content" id="step-3">
                        <div class="step-header">
                            <h2 class="step-title">
                                <i class="fas fa-chart-line step-icon"></i> Tension Mask Results
                            </h2>
                            <p class="step-subtitle">Cleaning process analysis and optimization recommendations</p>
                        </div>

                        <div class="step-body">
                            <div class="form-group">
                                <label for="cleaning-solution"> Result</label>
                                <input type="text" id="Result" placeholder="e.g., Isopropyl Alcohol, DI Water, etc.">
                            </div>

                            <div class="form-group">
                                <label for="cleaning-solution"> Person In Charge</label>
                                <input type="text" id="PIC" placeholder="e.g., Isopropyl Alcohol, DI Water, etc.">
                            </div>

                            <div class="form-group">
                                <label for="cleaning-solution"> Remarks</label>
                                <input type="text" id="Remarks" placeholder="e.g., Isopropyl Alcohol, DI Water, etc.">
                            </div>

                            <div style="margin-top: 30px;">
                                <h3 style="color: #1a3a5f; margin-bottom: 15px;">
                                    <i class="fas fa-lightbulb" style="margin-right: 10px; color: #2962ff;"></i>
                                    Optimization Recommendations
                                </h3>
                                <div id="recommendations">
                                    <ul style="color: #5a7184; line-height: 1.8;">
                                        <li>Increase cleaning solution temperature by 5-10°C to improve contaminant removal</li>
                                        <li>Consider adding a surfactant to reduce surface tension to 30-35 mN/m range</li>
                                        <li>Extend cleaning duration by 15% to reach optimal cleaning effectiveness</li>
                                        <li>Implement patterned masking to protect sensitive surface features</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step Navigation -->
                    <div class="step-navigation">
                        <button class="btn btn-prev" id="prev-btn" disabled>
                            <i class="fas fa-arrow-left"></i> Previous Step
                        </button>

                        <button class="btn btn-next" id="next-btn">
                            Next Step <i class="fas fa-arrow-right"></i>
                        </button>

                        <button class="btn btn-submit" id="submit-btn" style="display: none;">
                            <i class="fas fa-check-circle"></i> Complete Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>






<script>
    let selectID = 0;
    let debounceTimer;
    let setData = [];

    const loading = document.getElementById('loading');
    const emptyState = document.getElementById('emptyState');

     // ==== FILER by ModelType ===========
     $("#ModelSelect").on("change", function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            GetMetalMaskTensionCleaning();
        }, 400);
     });


     // ==== FILER by SMTLine ===========
     $("#SMTLine").on("change", function () {
         clearTimeout(debounceTimer);
         debounceTimer = setTimeout(() => {
             GetMetalMaskTensionCleaning();
         }, 400);
     });


     // ==== SEARCH FUNCTIONALITY =======
     $("#searchInput").on('keyup', () => {
         clearTimeout(debounceTimer);
         debounceTimer = setTimeout(() => {
             GetMetalMaskTensionCleaning();
         }, 400);
     });


    const GetMetalMaskTensionCleaning = async () => {
        showLoading(true);

        let partText = $("#searchInput").val();
        let SMTval = $("#SMTLine").val();
        let Modelval = $("#ModelSelect").val();
        try {
             const url = '@Url.Action("GetMetalMaskInformation", "MetalMask")';

             let res = await GetMethod(url,
                 {
                     search: partText,
                     SMTLine: SMTval,
                     Stats: 1,
                     ModelType: Modelval
                 });

             if (res?.Success) {
                  console.clear();
                   emptyState.style.display = 'none';
                   let tableBody = $("#TransactionTable");
                   tableBody.empty();
                   setData = res.data;
                   let html = "";

                 setTimeout(() => {
                     $.each(setData, function (index, row) {
                         // Image Display
                         let typename = "";

                         if (row.ModelType === 1) {
                             typename = "FAN";
                         } else if (row.ModelType === 2) {
                             typename = "UPS";
                         } else {
                             typename = "SERVO";
                         }

                         html += `
                           <tr class='cleanTable' data-id="${row.RecordID}">
                                 <td >${row.Partnumber ? row.Partnumber : "-"}</td>
                                 <td >${row.AREA ? row.AREA : "-"}</td>
                                 <td >Line ${row.SMTLine ? row.SMTLine : "-"}</td>
                                 <td >${row.Shift ? "NIGHTSHIFT" : "DAYSHIFT"}</td>
                                 <td >${row.Blocks ? row.Blocks : "-"}</td>
                                 <td >${typename}</td>
                           </tr>
                       `;
                     });

                     tableBody.append(html);
                     showLoading(false);

                 }, 500);

             } else {

                 setTimeout(() => {
                     // handle specific error types
                     //let TableBody = $("#TransactionTable");
                     let errorMessage = res?.Message || 'No Data found';

                     if (res?.errorType === 'NotFoundError') {
                         errorMessage = 'Api endpoint not found. Please contact the Administrator';
                     } else if (res?.errorType === 'UnauthorizedError') {
                         errorMessage = 'Your Session Token is expired. please refresh the page';
                     }
                     emptyState.style.display = 'block';
                     $("#Errormessage").text(errorMessage);

                     //TableBody.html(`<tr><td colspan="24" class="text-center text-danger">${errorMessage}</td></tr>`);

                     // Optional show a Toast
                     console.error("API Error : ", errorMessage, res);

                     showLoading(false);

                 }, 500);

             }
        } catch (error) {
            emptyState.style.display = 'block';
            $("#Errormessage").text('Unexpected error in GetMetalMaskTransaction:', error);
            console.error('Unexpected error in GetMetalMaskTransaction:', error);

        }
    };

    /* ============================
            CLICK HANDLER
    ============================ */
    $(document).on("click", ".cleanTable", function () {
        let recordId = $(this).data("id");
        selectID = recordId;

        currentStep = 1;
        updateStepper();

        let filtertable = setData.find(res => res.RecordID === selectID);
        console.log(filtertable);

        if (filtertable) {
            let cleanDate = filtertable.CleanDate
            // extract milliseconds
            let timestamp = parseInt(cleanDate.replace(/[^0-9]/g, ''));

            // create Date object
            let d = new Date(timestamp);

            // helpers
            const pad = n => n.toString().padStart(2, '0');

            // format for input[type="date"]
            let dateValue = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
            console.log("Date " + dateValue);
            // format for input[type="time"]
            let timeValue = `${pad(d.getHours())}:${pad(d.getMinutes())}`;
            console.log("Time " + timeValue);
            // set inputs
            document.getElementById("DateClean").value = dateValue;
            document.getElementById("DateTime").value = timeValue;
            document.getElementById("DateClean").readOnly = true;
            document.getElementById("DateTime").readOnly = true;

        }

        currentStep = 1;
        $("#Pattern").val("");
        $("#Frame").val("");
        $("#MaskPoint_1").val("");
        $("#MaskPoint_2").val("");
        $("#MaskPoint_3").val("");
        $("#MaskPoint_4").val("");
        $("#Result").val("");
        $("#Remarks").val("");
        $("#PIC").val("");
        $("#cleaningStepperModal").modal("show");
       
    });



    GetMetalMaskTensionCleaning();


    // === TENSION MASK INPUTS ===========
    document.addEventListener("DOMContentLoaded", () => {
        // 🔢 custom enter order
    const order = [
        "MaskPoint_1",
        "MaskPoint_2",
        "MaskPoint_3",
        "MaskPoint_4"
    ];

    const inputs = order.map(id => document.getElementById(id));

    inputs.forEach((input, index) => {

        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();

                validateInput(input);

                // 🔒 lock after enter
                input.readOnly = true;

                // ➡ focus next based on custom order
                if (index + 1 < inputs.length) {
                    inputs[index + 1].focus();
                }
            }
        });

        input.addEventListener("input", () => {
            validateInput(input);
        });
    });

        document.querySelectorAll(".MaskPoint").forEach(input => {
            input.addEventListener("input", () => {
                input.value = input.value.replace(/\D/g, "").slice(0, 2);
            });
        });

    function validateInput(input) {
        const value = Number(input.value);
        const circle = input.closest(".MaskCircle");

        if (value < 30 || value > 50 || input.value === "") {
            circle.classList.add("invalid");
        } else {
            circle.classList.remove("invalid");
        }
    }
    });





    // ==== MODAL STEPPER  ===========

    const stepItems = document.querySelectorAll('.step-item');
    const stepContents = document.querySelectorAll('.step-content');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const progressFill = document.getElementById('progress-fill');
    const tensionSlider = document.getElementById('surface-tension');
    const tensionValue = document.getElementById('tension-value');

    // Current step tracker
    let currentStep = 1;
    const totalSteps = stepItems.length;


    // Initialize the stepper
    function initStepper() {
        updateStepper();
        addEventListeners();

        // Initialize tension slider display
        if (tensionSlider) {
            tensionValue.textContent = tensionSlider.value + ' mN/m';
        }
    }

    // Update stepper UI based on current step
    function updateStepper() {
        // Update step items
        stepItems.forEach((item, index) => {
            const stepNumber = index + 1;

            // Remove all classes
            item.classList.remove('active', 'completed');

            // Add appropriate classes
            if (stepNumber === currentStep) {
                item.classList.add('active');
            } else if (stepNumber < currentStep) {
                item.classList.add('completed');
            }
        });

        // Update step contents
        stepContents.forEach((content, index) => {
            const stepNumber = index + 1;
            content.classList.toggle('active', stepNumber === currentStep);
        });

        // Update navigation buttons
        prevBtn.disabled = currentStep === 1;

        // Update progress bar
        progressFill.style.width = ((currentStep - 1) / (totalSteps - 1)) * 100 + '%';

        // Show/hide next and submit buttons
        if (currentStep === totalSteps) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
            //updateResults();
        } else {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }

        // Update step numbers with icons for completed steps
        stepItems.forEach((item, index) => {
            const stepNumber = item.querySelector('.step-number');
            const step = index + 1;

            if (step < currentStep) {
                stepNumber.innerHTML = '<i class="fas fa-check"></i>';
            } else {
                stepNumber.textContent = step;
            }
        });
    }

    // Navigate to a specific step
    function goToStep(step) {
        if (step < 1 || step > totalSteps) return;
        currentStep = step;


        updateStepper();
    }

    // Navigate to next step
    function nextStep() {

        if (!ValidationForm()) {
            return;
        }

        if (currentStep < totalSteps) {
            currentStep++;
            updateStepper();
        }
    }

    // Navigate to previous step
    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepper();
        }
    }

    async function updateResults() {
        let formData = new FormData();
        formData.append('RecordID', parseInt(selectID));
        formData.append('Pattern', $("#Pattern").val() ||"");
        formData.append('Frame', $("#Frame").val() || "");
        formData.append('ReadOne', $("#MaskPoint_1").val() || "");
        formData.append('ReadTwo', $("#MaskPoint_2").val() || "");
        formData.append('ReadThree', $("#MaskPoint_3").val() || "");
        formData.append('ReadFour', $("#MaskPoint_4").val() || "");
        formData.append('Result', $("#Result").val() || "");
        formData.append('Remarks', $("#Remarks").val() || "");
        formData.append('PIC', $("#PIC").val() || "");

        const data = Object.fromEntries(formData);

        let res = await postMethod('@Url.Action("SubmitTensionAndCleaning", "MetalMask")', formData);
        if (res?.Success) {
            GetMetalMaskTensionCleaning();
            GetTheTotalCount();
            ResetFormsSepper();
        }
    }

    function ResetFormsSepper() {
        selectID = 0;
        $("#Pattern").val("");
        $("#Frame").val("");
        $("#MaskPoint_1").val("");
        $("#MaskPoint_2").val("");
        $("#MaskPoint_3").val("");
        $("#MaskPoint_4").val("");
        $("#Result").val("");
        $("#Remarks").val("");
        $("#PIC").val("");

        $("#cleaningStepperModal").modal('hide');
    }

    function ValidationForm() {
        // ====================================
        // ========  Validation Input =========
        // ====================================

        // FRAME 1
        if (currentStep === 1) {
            let patText = $("#Pattern").val();
            let frameText = $("#Frame").val();

            if (patText === "" || frameText === "") {
                alert("fill up all the Cleaning info first");
                return false;
            }
        }
        // FRAME 2
        if (currentStep === 2) {
            if ($("#MaskPoint_1").val() === "" || $("#MaskPoint_2").val() === "" || $("#MaskPoint_3").val() === "" || $("#MaskPoint_4").val() === "") {
                alert("fill up all the Mask Point ");
                return false;
            }
        }

        // FRAME 3
        if (currentStep === 3) {
            if ($("#Result").val() === "" || $("#PIC").val() === "" || $("#Remarks").val() === "" ) {
                alert("fill up all the input field required");
                return false;
            }
        }

        return true;
        // ====================================
    }
   

    // Complete the analysis
    function completeAnalysis() {

        if (!ValidationForm()) {
            return;
        }
        updateResults();
    }

    // Add event listeners
    function addEventListeners() {
        // Previous button
        prevBtn.addEventListener('click', prevStep);

        // Next button
        nextBtn.addEventListener('click', nextStep);

        // Submit button
        submitBtn.addEventListener('click', completeAnalysis);

        // Step items click to navigate directly
        stepItems.forEach(item => {
            item.addEventListener('click', function () {
                const step = parseInt(this.getAttribute('data-step'));
                goToStep(step);
            });
        });

        // Tension slider
        if (tensionSlider) {
            tensionSlider.addEventListener('input', function () {
                tensionValue.textContent = this.value + ' mN/m';
            });
        }

        // Update results when inputs change on step 3
        //const formInputs = document.querySelectorAll('input, select, textarea');
        //formInputs.forEach(input => {
        //    input.addEventListener('change', function () {
        //        if (currentStep === 3) {
        //            updateResults();
        //        }
        //    });
        //});

        // Keyboard navigation
        document.addEventListener('keydown', function (event) {
            if (event.key === 'ArrowRight' || event.key === ' ') {
                // Next on right arrow or space
                if (currentStep < totalSteps) {
                    event.preventDefault();
                    nextStep();
                }
            } else if (event.key === 'ArrowLeft') {
                // Previous on left arrow
                if (currentStep > 1) {
                    event.preventDefault();
                    prevStep();
                }
            }
        });
    }

    // Initialize when the page loads
    document.addEventListener('DOMContentLoaded', initStepper);


    // Show loading state
    function showLoading(show = true) {
        loading.classList.toggle('active', show);
    }
</script>