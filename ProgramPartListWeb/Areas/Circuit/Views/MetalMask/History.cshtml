
@{
    ViewBag.Title = "History";
    Layout = "~/Areas/Circuit/Views/Shared/_MaskLayout.cshtml";
}


<div class="headerMask">
    <div class="flex_align">
        <input type="text" id="searchID" placeholder="Search here ... " />
        <p style="font-weight: 600;">Search Partnumber : <span id="searchText">-- N/A --</span></p>
    </div>
    <div class="flex_align">
        <button id="btnNGpage" class="btn btn-success">
            NG Data <span id="NGcount"></span>
        </button>
        <button id="btnExport" class="btn btn-success">
            Export Selected
        </button>
    </div>
</div>

<div>
    
</div>

<div class="TrackTable" style="margin-top: 1em;">
    <table>
        <thead>
            <tr>
                <th></th>
                <th>Date </th>
                <th>Shift</th>
                <th>SMT Line</th>
                <th>Area </th>
                <th>Metal Mask Partno.</th>
                <th>Block No.</th>
                <th>Start Time</th>
                <th>End Time</th>
                <th>Total Time</th>
                <th>Total Printed Board</th>
                <th>SMT operator</th>
                <th>Date cleaning</th>

                <th>Time of Cleaning </th>
                <th>Pattern</th>
                <th>Frame</th>
                <th>Point 1 </th>
                <th>Point 2</th>
                <th>Point 3</th>
                <th>Point 4</th>
                <th>Result</th>
                <th>Tension Condition</th>
                <th>Person in charge</th>
            </tr>
        </thead>
        <tbody id="TransactionTable">
        </tbody>
    </table>

</div>







<script>
    let selectedID = 0;
    let searchCount = 0;
    let debounceTimer;
    let tempPartnum = "";

    let TableBody = $("#TransactionTable");

    // ==== SEARCH FUNCTIONALITY =======
    $("#searchID").on('keyup', (e) => {
        if (e.key !== "Enter") return;
        let tempText = $("#searchID").val();


        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            GetMetalMaskTransaction();
            $("#searchID").val("");
            $("#searchText").text(tempText);
            tempPartnum = tempText; 
            GetTotalIncompleteMask(tempText);
        }, 400);
    });



    $("#btnExport").on("click", function () {

        let selectedIds = [];

        $(".row-check:checked").each(function () {
            selectedIds.push($(this).val());
        });

        if (selectedIds.length === 0) {
            alert("Please select at least one record to export.");
            return;
        }


          $.ajax({
              url: '@Url.Action("ExportMetalMask", "MetalMask")',
              type: 'POST',
              data: JSON.stringify({ recordIds: selectedIds }),
              contentType: 'application/json; charset=utf-8',
              xhrFields: {
                  responseType: 'blob' // IMPORTANT for file download
              },
              success: function (data, status, xhr) {

                  // Get filename from response header
                  var filename = "MetalMask.xlsx";
                  var disposition = xhr.getResponseHeader('Content-Disposition');
                  if (disposition && disposition.indexOf('filename=') !== -1) {
                      filename = disposition.split('filename=')[1].replace(/"/g, '');
                  }

                  // Create download
                  var blob = new Blob([data], {
                      type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                  });

                  var link = document.createElement('a');
                  link.href = window.URL.createObjectURL(blob);
                  link.download = filename;
                  document.body.appendChild(link);
                  link.click();
                  document.body.removeChild(link);
              },
              error: function () {
                  alert("Export failed.");
              }
          });
    });


    $("#btnNGpage").on('click', () => {
        if (tempPartnum === "" || searchCount === 0) {
            $("#searchID").focus();
            return;
        }
        window.location.href = "/Circuit/MetalMask/IncompleteMaskInfo?partnum=" + tempPartnum;
    });


    async function exportSelected(ids) {
       let formData = new FormData();

        ids.forEach((id, index) => {
            formData.append(`recordIds[${index}]`, id);
        });

        const response = await fetch('@Url.Action("ExportMetalMask", "MetalMask")', {
            method: "POST",
            body: formData
        });

        if (response.status === 204) {
            alert("No data to export.");
            return;
        }

        if (!response.ok) {
            alert("Export failed.");
            return;
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "MetalMask.xlsx";
        document.body.appendChild(a);
        a.click();

        a.remove();
        window.URL.revokeObjectURL(url);

    }

    const GetMetalMaskTransaction = async () => {
        try {
            searchCount = 0;

           const url = '@Url.Action("GetMetalMaskInformation", "MetalMask")';
            // Add spinner/loading indicator
            $("#TransactionTable").html('<tr><td colspan="24" class="text-center"><div class="spinner-border" role="status"></div> Loading...</td></tr>');

            let res = await GetMethod(url, {
                search: $("#searchID").val() || "",
                SMTLine: 0,
                Stats: 2,
                ModelType: 0
            });

            if (res?.Success) {
                let tableBody = $("#TransactionTable");
                tableBody.empty();
                let TableData = res.data;
                searchCount = TableData.length;
                let html = "";


                $.each(TableData, function (index, row) {
                    // Image Display
                    html += `
                      <tr class="fade-in">
                            <td>
                                   <input type="checkbox"
                                   class="row-check"
                                   name="checkID"
                                   value="${row.RecordID}">
                            </td>

                            <td >${row.DateInput ? formatJsonDate(row.DateInput) : "-"}</td>
                            <td >${row.Shift ? row.Shift : "-"}</td>
                            <td >${row.SMTLine ? row.SMTLine : "-"}</td>
                            <td >${row.AREA ? row.AREA : "-"}</td>
                            <td >${row.Partnumber ? row.Partnumber : "-"}</td>
                            <td >${row.Blocks ? row.Blocks : "-"}</td>
                            <td >${row.SMT_start ? row.SMT_start : "-"}</td>
                            <td >${row.SMT_end ? row.SMT_end : "-"}</td>
                            <td >${row.TotalTime ? row.TotalTime : "-"}</td>
                            <td >${row.TotalPrintBoard ? row.TotalPrintBoard : "-"}</td>
                            <td >${row.SMT_Operator ? row.SMT_Operator : "-"}</td>

                           <td >${row.CleanDate ? formatJsonDate(row.CleanDate) : "-"}</td>
                           <td >${row.CleanDate ? formatJsonDate(row.CleanDate) : "-"}</td>
                           <td >${row.Pattern ? row.Pattern : "-"}</td>
                           <td >${row.Frame ? row.Frame : "-"}</td>
                           <td >${row.ReadOne ? row.ReadOne : "-"}</td>
                           <td >${row.ReadTwo ? row.ReadTwo : "-"}</td>
                           <td >${row.ReadThree ? row.ReadThree : "-"}</td>
                           <td >${row.ReadFour ? row.ReadFour : "-"}</td>
                           <td >${row.Result ? row.Result : "-"}</td>
                           <td >${row.Remarks ? row.Remarks : "-"}</td>
                           <td >${row.PIC ? row.PIC : "-"}</td> "-"}</td>
                      </tr>
                  `;
                });

                tableBody.append(html);
            } else {
                // handle specific error types

                let errorMessage = res?.Message || 'failed to load data';

                if (res?.errorType === 'NotFoundError') {
                    errorMessage = 'Api endpoint not found. Please contact the Administrator';
                } else if (res?.errorType === 'UnauthorizedError') {
                    errorMessage = 'Your Session Token is expired. please refresh the page';
                }

                TableBody.html(`<tr>
                       <td colspan='23'>
                           🔍 ${errorMessage}
                       </td>
                   </tr>`);

                // Optional show a Toast
                console.error("API Error : ", errorMessage, res);
            }

        } catch (error) {
            console.error('Unexpected error in GetMetalMaskTransaction:', error);
            $("#TransactionTable").html('<tr><td colspan="24" class="text-center text-danger">An unexpected error occurred</td></tr>');
        }

    }


    const GetTotalIncompleteMask = async (partnumText) => {
        try {

           const url = '@Url.Action("GetMetalMaskINCOMPLETE", "MetalMask")';

            let res = await GetMethod(url, {
                partnum: partnumText
            });

            let countpart = res?.Success ? res.data.length : 0;
            $("#NGcount").show();
            $("#NGcount").text(`(${countpart})`);
            

        } catch (error) {
            $("#NGcount").hide();
            $("#NGcount").text("(0)");
        }
    }

    TableBody.empty();

    TableBody.html(`<tr class='cleanTable'>
          <td colspan='23'>
              🔍 No Partnumber Found
          </td>
      </tr>`);
</script>