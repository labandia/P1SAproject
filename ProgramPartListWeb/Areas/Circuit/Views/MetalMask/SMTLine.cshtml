
@{
    ViewBag.Title = "SMTLine";
    Layout = "~/Areas/Circuit/Views/Shared/_MaskLayout.cshtml";
}


<div class="SMTGrid_container">
    <div class="SMT_tables">
        <!-- Controls Section -->
        <div class="controls-section">
            <div class="control-group">
                <label class="control-label">
                    <i class="fas fa-search"></i> Search Partnumber
                </label>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Enter Partnumber ..." autocomplete="off">
                </div>
            </div>




            <div class="control-group">
                <label class="control-label">
                    <i class="fas fa-calendar"></i> SMT Line
                </label>
                <select id="SMTLine" class="filter-select">
                    @for (int i = 1; i <= 12; i++)
                    {
                        <option value="@i">Line @i</option>
                    }
                </select>
            </div>




        </div>

        <hr  style="margin: 0;" />
      
        <section class="Maskcardcontainer mt-3" id="Maskcardcontainer"></section>



    </div>
    <div class="SMT_Timer">
        <div class="StopWatchContainer">
            <div class="StopWatch_header">
                <h6><i class="fas fa-stopwatch"></i> SMT Line Timer</h6>
            </div>
            <div class="StopWatch_Content">
                <!-- Selected Operation Info -->
                <div class="selected-operation">
                    <div class="operation-header">
                        <h4 id="partnumText">-- Select Operation --</h4>
                        <span class="operation-badge" id="operationBadge">IDLE</span>
                    </div>
                    <div class="operation-details">
                        <div class="detail-item">
                            <label><i class="fas fa-map-marker-alt"></i> Area</label>
                            <span id="AreaV2Text">--</span>
                        </div>
                        <div class="detail-item">
                            <label><i class="fas fa-cube"></i> Blocks</label>
                            <span id="BlockV2Text">--</span>
                        </div>
                        <div class="detail-item">
                            <label><i class="fas fa-industry"></i> Line</label>
                            <span id="lineText">--</span>
                        </div>
                    </div>
                </div>

                <div class="timercontainer">
                    <div class="flex_align" style="gap:30px;">
                        <div class="timerwatchform">
                            <label>  Start Time</label>
                            <p id="StartText">--:--</p>
                        </div>

                        <div class="timerwatchform">
                            <label> End Time</label>
                            <p id="EndText">--:--</p>
                        </div>


                        <div class="timerwatchform">
                            <label><i class="fas fa-hourglass-half"></i>  Total Time</label>
                            <p id="TotalTimeText">00:00</p>
                        </div>
                    </div>


                    <div class="flex_align TimeAction">
                        <button type="button" id="startbtn"> <i class="fas fa-play"></i> </button>
                        <button type="button" id="endbtn">  <i class="fas fa-stop"></i>  </button>
                    </div>
                </div>

                <hr />
                <div class="Stopwatchform">
                    <label>Print Board :</label> <br />
                    <input type="number" id="TotalPrintBoard" placeholder="Enter Total Print Board" /> <br />
                </div>

                <div class="Stopwatchform">
                    <label>Operator name:  </label><br />
                    <input type="text" id="SMT_Operator" placeholder="Enter Operator" />
                </div>



                <button type="button" id="saveSMT" disabled><i class="fa-regular fa-floppy-disk"></i> Save</button>
            </div>
            </div>
    </div>
</div>








<script>
    let selectedID = 0;
    const activeTimers = [];
    let SMTData = [];
    const startbtn = document.getElementById("startbtn");
    const endbtn = document.getElementById("endbtn");
    const saveSMT = document.getElementById("saveSMT");

    const operationBadge = document.getElementById('operationBadge');

    let selectedTimer = null;




    saveSMT.addEventListener('click', async function (e) {
          e.preventDefault();


          let formdata = new FormData();
          formdata.append('TotalPrintBoard', $("#TotalPrintBoard").val());
          formdata.append('SMT_Operator', $("#SMT_Operator").val());
          formdata.append('RecordID', selectedID);

          let res = await postData('@Url.Action("FinalSubmitSMTLineinfo", "MetalMask")', formdata);
          if (res?.Success) {
              GetMetalMaskTransaction();
              GetTheTotalCount();

              $("#partnumText").text("-- N/A --");
              $("#AreaV2Text").text("-- N/A --");
              $("#BlockV2Text").text("-- N/A --");
              $("#StartText").text("--:--");
              $("#EndText").text("--:--");
              $("#TotalTimeText").text("00:00");
              $("#TotalPrintBoard").val("");
              $("#SMT_Operator").val("");
          }
          updateOperationStatus(2);
     });


    startbtn.addEventListener('click', async function (e) {
        e.preventDefault();

        if (!selectedID) {
            alert('Please select an operation first');
            return;
        }

        try {
            let formdata = new FormData();
            formdata.append('ID', selectedID);

            const res = await postData('@Url.Action("StartSMTOperation", "MetalMask")', formdata);

            if (res?.Success) {
                $("#startbtn").prop("disabled", true);
                $("#endbtn").prop("disabled", false);

                // ▶ Set start time
                const startTime = timeNow();
                $("#StartText").text(startTime);
                $("#EndText").text("--:--");
                $("#TotalTimeText").text("00:00");


                updateOperationStatus(1);
                if (selectedTimer) clearInterval(selectedTimer);

                // ▶ Start stopwatch immediately
                const startDate = new Date();
                startDate.setSeconds(0, 0);

                selectedTimer = setInterval(() => {
                    const now = new Date();
                    let diffMin = Math.floor((now - startDate) / 60000);
                    if (diffMin < 0) diffMin = 0;

                    $("#TotalTimeText").text(formatDuration(diffMin));
                }, 1000);


                GetMetalMaskTransaction();

            }
        } catch (error) {
            console.error('Failed to start operation:', error);
        }
    });

    endbtn.addEventListener('click', async function (e) {
        e.preventDefault();

        if (!selectedID) {
            alert('Please select an operation first');
            return;
        }

        try {
            let formdata = new FormData();
            formdata.append('ID', selectedID);

            $("#startbtn").prop("disabled", true);
            $("#endbtn").prop("disabled", true);

            let res = await postData('@Url.Action("EndSMTOperation", "MetalMask")', formdata);

            if (res?.Success) {
                $("#EndText").text(timeNow());


                 GetMetalMaskTransaction();
                 updateOperationStatus(2);
                 $('#TotalPrintBoard').focus();
            }
        } catch (error) {
            console.error('Failed to end operation:', error);
        }

    });

    $("#SMT_Operator").on('keyup', function () {
        let textType = $(this).val().trim();

        if (textType !== "" && selectedID !== 0) {
            $("#saveSMT").prop("disabled", false);

        } else {
            $("#saveSMT").prop("disabled", true);
        }

    });

    const GetMetalMaskTransaction = async () => {
        // STOP old timers
        activeTimers.forEach(clearInterval);
        activeTimers.length = 0;


         let res = await fetchData('@Url.Action("GetMetalMaskInformation", "MetalMask")', { Stats: 1 });
         $("#Maskcardcontainer").empty();

        if (res?.Success) {

             let TableData = res.Data;
             SMTData = TableData;
             let html = "";

             res.Data.forEach(rowData => {

                 html += `<div class="Maskcard" data-id="${rowData.RecordID}">
                        <div class="MaskHeader">
                            <h5>Metal mask rev partnum : <span>${rowData.Partnumber}</span></h5>
                        </div>

                        <div class="MaskContent">
                            <div><label>SMT Line</label><p>${rowData.SMTLine}</p></div>
                            <div><label>Area</label><p>${rowData.AREA}</p></div>
                            <div><label>Shift</label><p>${rowData.Shift != false ? "DS" : "NS"}</p></div>
                            <div><label>Blocks</label><p>${rowData.Blocks}</p></div>
                        </div>

                        <div class="MaskContent">
                            <div>
                                <label>Start Time</label>
                                 <p>${rowData.SMT_start === "00:00" ? "--:--" : rowData.SMT_start}</p>
                            </div>

                            <div>
                                <label>End Time</label>
                               <p>${rowData.SMT_end === "00:00" ? "--:--" : rowData.SMT_end}</p>
                            </div>

                            <div>
                                <label>Total Time</label>
                                  <p class="total-time">${rowData.TotalTimeHHMM}</p>
                            </div>
                        </div>
                    </div>`;
            });

            $("#Maskcardcontainer").append(html);



            /* ============================
                  START REALTIME TIMERS
               ============================ */

            document.querySelectorAll(".Maskcard").forEach((card, i) => {

                const row = res.Data[i];

                // Only run if still active
                if (row.SMT_end !== "00:00") return;
                const changeDate = formatJsonDate(row.DateInput);
                const startDate = parseTime(changeDate, row.SMT_start);
                const timer = startRealtimeTimer(card, changeDate, row.SMT_start);

                activeTimers.push(timer);
            });


         }
    };

    /* ============================
         CLICK HANDLER
        ============================ */


    document.addEventListener("click", e => {
        const card = e.target.closest(".Maskcard");
        if (!card) return;

        const id = parseInt(card.dataset.id);
        selectedID = id;

        $("#startbtn").prop("disabled", false);
        $("#endbtn").prop("disabled", false);

        let filterData = SMTData.find(res => res.RecordID == selectedID);

        // ❌ stop previous stopwatch
        if (selectedTimer) clearInterval(selectedTimer);

        if (filterData) {
            $("#partnumText").text(filterData.Partnumber);
            $("#AreaV2Text").text(filterData.AREA);
            $("#BlockV2Text").text(filterData.Blocks);
            $("#StartText").text(filterData.SMT_start === "00:00" ? "--:--" : filterData.SMT_start);
            $("#EndText").text(filterData.SMT_end === "00:00" ? "--:--" : filterData.SMT_end);
            $("#TotalTimeText").text(filterData.TotalTimeHHMM === "00:00" ? "00:00" : filterData.TotalTimeHHMM);


            if (filterData.SMT_start === "00:00" && filterData.SMT_end === "00:00" && filterData.TotalTimeHHMM === "00:00") {
                updateOperationStatus(0);
            }



            if (filterData.SMT_start !== "00:00" && filterData.SMT_end === "00:00") {
                $("#startbtn").prop("disabled", true);
                $("#endbtn").prop("disabled", false);
                updateOperationStatus(1);
                startSelectedStopwatch(formatJsonDate(filterData.DateInput), filterData.SMT_start);

                return;
            }


            if (filterData.TotalTimeHHMM !== "00:00") {
                $("#startbtn").prop("disabled", true);
                $("#endbtn").prop("disabled", true);
                $('#TotalPrintBoard').focus();
                updateOperationStatus(2);
                return;
            }
        }
    });

    $("#startbtn").prop("disabled", true);
    $("#endbtn").prop("disabled", true);

    GetMetalMaskTransaction();



    /* ============================
     HELPERS
  ============================ */
    function buildStartDate(dateInput, smtStart) {
        const d = new Date(dateInput);
        const [h, m] = smtStart.split(":").map(Number);

        return new Date(
            d.getFullYear(),
            d.getMonth(),
            d.getDate(),
            h,
            m,
            0
        );
    }

    function timeNow() {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, '0');
        const mm = String(now.getMinutes()).padStart(2, '0');

        const time = `${hh}:${mm}`;

        return time;
    }

    function parseTime(dateInput, timeStr) {
        const d = new Date(dateInput);
        const [h, m] = timeStr.split(":").map(Number);

        return new Date(
            d.getFullYear(),
            d.getMonth(),
            d.getDate(),
            h,
            m,
            0
        );
    }

    function formatDuration(minutes) {
        const h = Math.floor(minutes / 60);
        const m = minutes % 60;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    /* ============================
       REALTIME TIMER
    ============================ */

    function startRealtimeTimer(cardEl, dateInput, smtStart) {

        const startDate = buildStartDate(dateInput, smtStart);


        function update() {
            const now = new Date();
            let diffMin = Math.floor((now - startDate) / 60000);

            // Safety guard
            if (diffMin < 0) diffMin = 0;

            cardEl.querySelector(".total-time")
                .textContent = formatDuration(diffMin);
        }

        update();
        return setInterval(update, 1000);
    }


    function startSelectedStopwatch(dateInput, smtStart) {

        // stop old timer
        if (selectedTimer) clearInterval(selectedTimer);

        const startDate = buildStartDate(dateInput, smtStart);

        function update() {
            const now = new Date();
            let diffMin = Math.floor((now - startDate) / 60000);
            if (diffMin < 0) diffMin = 0;

            const formatted = formatDuration(diffMin);
            $("#TotalTimeText").text(formatted);
        }

        update();
        selectedTimer = setInterval(update, 1000);
    }


    function updateOperationStatus(status){
        const labels = [
            'NOT STARTED',  // 0
            'IN PROGRESS',  // 1
            'COMPLETED'     // 2
        ];

        const colors = [
            '#fbbf24', // 0 - pending
            '#4cc9f0', // 1 - running
            '#4ade80'  // 2 - completed
        ];

        operationBadge.textContent = labels[status] ?? 'UNKNOWN';
        operationBadge.style.background = colors[status] ?? '#6c757d';
    }



</script>

