@{ 
    ViewBag.Title = "Program Partlist";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="~/Content/Images/ready-stock.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Learn how to improve your website with caching, accessibility, and SEO best practices.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title</title>
    <link href="~/Content/Shared/bootstrap.min.css" rel="stylesheet" />


    <link href="~/Content/css/Programpartlist.css" rel="stylesheet" />
    <script src="~/Scripts/bootstrap.bundle.min.js"></script>

    @Styles.Render("~/Content/shared-css")

    @Scripts.Render("~/bundles/shared-js")
    @Scripts.Render("~/bundles/modernizr")
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="brand">📁 Program PartList</div>
            <div class="menu" id="sidebarMenu">
                <button data-key="Dashboard" data-title="Dashboard" data-url="@Url.Action("Dashboard", "ProgramPartList")">
                    <span class="dot"></span><span>Dashboard</span>
                </button>

                <button data-key="ManageSchedule" data-title="Plan Schedule" data-url="@Url.Action("ManagePlanSchedule", "ProgramPartList")">
                    <span class="dot"></span><span>Partlist Data</span>
                </button>
                <button data-key="PDAView" data-title="PDAView" data-url="@Url.Action("PDAView", "ProgramPartlist")">
                    <span class="dot"></span><span>PDA view</span>
                </button>
                <button data-key="PlanSchedule" data-title="Plan Schedule" data-url="@Url.Action("PlanSchedule", "ProgramPartlist")">
                    <span class="dot"></span><span>Plan Schedule</span>
                </button>
                <button data-key="Warehouse" data-title="Warehouse" data-url="@Url.Action("ManageWarehouse", "ProgramPartlist")">
                    <span class="dot"></span><span>Warehouse</span>
                </button>
                <button data-key="Components" data-title="Comp out" data-url="@Url.Action("ComponentsOut", "ProgramPartlist")">
                    <span class="dot"></span><span>Comp out</span>
                </button>
                <button data-key="settings" data-title="Settings">
                    <span class="dot"></span><span>Settings</span>
                </button>
            </div>

            <div style="margin-top: auto; padding: 12px; background: rgba(255,255,255,.02); border-radius: 10px;">
                <div class="muted" style="font-size: 12px; margin-bottom: 6px;">Performance Stats</div>
                <div style="font-size: 12px; display: flex; justify-content: space-between;">
                    <span>Tabs Open: <span id="tabCount">1</span></span>
                    <span>Cached: <span id="cachedCount">0</span></span>
                </div>
            </div>
        </aside>

        <!-- MAIN AREA -->
        <main class="main">

            <!-- Dynamic Tabs -->
            <div class="tabs" id="tabBar" aria-label="Open tabs" style="color: #fff;"></div>

            <!-- Dynamic Content (Your SPAs / Panels) -->
            <div class="content" id="contentArea" aria-live="polite"></div>

            <!-- MVC Body Section (Your Views Render Here) -->
            <div id="mvcContent">
                @RenderBody()
            </div>

        </main>
    </div>



    <script src="~/Scripts/bootstrap.min.js"></script>
    <script src="~/Scripts/Popper.min.js"></script>
    <script type="text/javascript">
        // Tab Management System
        const tabBar = document.getElementById('tabBar');
        const contentArea = document.getElementById('contentArea');
        const mvcContent = document.getElementById('mvcContent');
        const sidebarMenu = document.getElementById('sidebarMenu');
        const tabCountEl = document.getElementById('tabCount');
        const cachedCountEl = document.getElementById('cachedCount');

        // Tab registry
        const tabs = new Map();
        const cache = new Map();
        let activeTabKey = null;
        let mvcContentKey = 'mvc-' + Date.now(); // Unique key for initial MVC content


        // Update the initial display in your JavaScript
        document.addEventListener('DOMContentLoaded', function () {
            // Initially hide the tab bar
            //tabBar.style.display = 'none';

            // Make sure MVC content is visible
            mvcContent.style.display = 'block';
            contentArea.style.display = 'none';

            // Rest of your initialization code...
        });

        // Initialize with current MVC view
        document.addEventListener('DOMContentLoaded', function () {
            const currentTitle = '@ViewBag.Title' || 'Dashboard';
            const currentUrl = window.location.pathname + window.location.search;

            // Store initial MVC content as a tab
            tabs.set(mvcContentKey, {
                title: currentTitle,
                url: currentUrl,
                tabEl: null,
                isLoaded: true,
                isMvc: true,
                content: mvcContent.innerHTML
            });

            updateTabStats();
        });

        // Function to open a page in a new tab
        function openPageInTab(key, title, url) {
            // Check if tab already exists
            for (const [tabKey, tab] of tabs) {
                if (tab.url === url) {
                    activateTab(tabKey);
                    return;
                }
            }

            // Create tab element
            const tab = document.createElement('div');
            tab.className = 'tab';
            tab.dataset.key = key;
            tab.innerHTML = `
                <span>${title}</span>
                <span class="close" title="Close tab" aria-label="Close tab">✕</span>
            `;

            // Add click events
            tab.addEventListener('click', (e) => {
                const isClose = e.target.closest('.close');
                if (isClose) {
                    closeTab(key);
                    return;
                }
                activateTab(key);
            });

            tab.addEventListener('auxclick', (e) => {
                if (e.button === 1) {
                    closeTab(key);
                }
            });

            // Show tab bar
            tabBar.style.display = 'flex';

            // Add to DOM
            tabBar.appendChild(tab);

            // Store tab reference
            tabs.set(key, {
                title,
                url,
                tabEl: tab,
                isLoaded: false,
                isMvc: false,
                content: null
            });

            // Activate this tab
            activateTab(key);
            updateTabStats();
        }

        // Function to activate a tab
        function activateTab(key) {
            const ctx = tabs.get(key);
            if (!ctx) return;

            // Hide all content areas
            contentArea.style.display = 'none';
            mvcContent.style.display = 'none';

            // Update tab UI
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            if (ctx.tabEl) {
                ctx.tabEl.classList.add('active');
            }

            // Update sidebar active state
            document.querySelectorAll('.menu button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-key') === key) {
                    btn.classList.add('active');
                }
            });

            // Show appropriate content
            if (ctx.isMvc) {
                mvcContent.style.display = 'block';
            } else {
                contentArea.style.display = 'block';

                // Load content if not already loaded
                if (!ctx.isLoaded) {
                    loadTabContent(key, ctx.url);
                } else if (ctx.content) {
                    contentArea.innerHTML = ctx.content;
                }
            }

            activeTabKey = key;

            // Scroll tab into view
            if (ctx.tabEl) {
                ctx.tabEl.scrollIntoView({ inline: 'center', behavior: 'smooth' });
            }
        }

        // Function to load tab content
        function loadTabContent(key, url) {
            const ctx = tabs.get(key);
            if (!ctx || ctx.isLoaded) return;

            // Show loading state
            if (ctx.tabEl) {
                ctx.tabEl.classList.add('loading');
            }
            contentArea.innerHTML = '<div class="spinner"></div>';

            // Check cache first
            if (cache.has(url)) {
                const cached = cache.get(url);
                contentArea.innerHTML = cached.content;
                ctx.isLoaded = true;
                ctx.content = cached.content;
                if (ctx.tabEl) ctx.tabEl.classList.remove('loading');
                updateCacheStats();
                return;
            }

            // Fetch content
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(html => {
                    // Parse HTML and extract main content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');

                    // Try to find main content
                    let mainContent = doc.querySelector('#mvcContent') ||
                                     doc.querySelector('main') ||
                                     doc.querySelector('.container') ||
                                     doc.body;

                    // Clean up HTML
                    let content = mainContent.innerHTML;

                    // Remove scripts to avoid conflicts
                    content = content.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');

                    contentArea.innerHTML = content;
                    ctx.isLoaded = true;
                    ctx.content = content;

                    if (ctx.tabEl) ctx.tabEl.classList.remove('loading');

                    // Cache the content
                    cache.set(url, {
                        content: content,
                        timestamp: Date.now()
                    });
                    updateCacheStats();
                })
                .catch(error => {
                    console.error('Failed to load tab content:', error);
                    contentArea.innerHTML = `
                        <div class="card">
                            <h2>Error Loading Content</h2>
                            <div class="status-message error">
                                Failed to load content from ${url}
                            </div>
                            <button class="btn" onclick="retryLoad('${key}', '${url}')">Retry</button>
                        </div>
                    `;
                    if (ctx.tabEl) ctx.tabEl.classList.remove('loading');
                });
        }

        // Retry loading
        window.retryLoad = function(key, url) {
            const ctx = tabs.get(key);
            if (ctx) {
                ctx.isLoaded = false;
                loadTabContent(key, url);
            }
        };

        // Function to close a tab
        function closeTab(key) {
            const ctx = tabs.get(key);
            if (!ctx) return;

            const wasActive = ctx.tabEl && ctx.tabEl.classList.contains('active');

            // Remove from DOM
            if (ctx.tabEl) {
                ctx.tabEl.remove();
            }
            tabs.delete(key);

            // If closing active tab and other tabs exist
            if (wasActive && tabs.size > 0) {
                const lastKey = Array.from(tabs.keys()).pop();
                activateTab(lastKey);
            }
            // If no tabs left, show MVC content
            else if (tabs.size === 0) {
                contentArea.style.display = 'none';
                mvcContent.style.display = 'block';
                tabBar.style.display = 'none';
                activeTabKey = mvcContentKey;

                // Reset sidebar active state
                document.querySelectorAll('.menu button').forEach(btn => {
                    btn.classList.remove('active');
                });
            }

            updateTabStats();
        }

        // Function to refresh a tab
        window.refreshTab = function (key) {
            const ctx = tabs.get(key);
            if (ctx && !ctx.isMvc) {
                ctx.isLoaded = false;
                cache.delete(ctx.url);
                loadTabContent(key, ctx.url);
            }
        };

        // Update stats
        function updateTabStats() {
            tabCountEl.textContent = tabs.size - 1; // Subtract the MVC content tab
        }

        function updateCacheStats() {
            cachedCountEl.textContent = cache.size;
        }

        // Sidebar click handler
        sidebarMenu.addEventListener('click', function (e) {
            const button = e.target.closest('button[data-key]');
            if (!button) return;

            e.preventDefault();
            e.stopPropagation();

            const key = button.getAttribute('data-key');
            const title = button.getAttribute('data-title') || button.querySelector('span:nth-child(2)').textContent;
            const url = button.getAttribute('data-url');
            const apiUrl = button.getAttribute('data-api');

            if (url) {
                // Open MVC page in tab
                openPageInTab(key, title, url);
            } else if (apiUrl) {
                // Open API data in tab
                openApiInTab(key, title, apiUrl);
            } else {
                // Open static content in tab
                openStaticTab(key, title);
            }
        });

        // Open API data in tab
        function openApiInTab(key, title, apiUrl) {
            openPageInTab(key, title, '#api');

            // Load API data
            const ctx = tabs.get(key);
            if (ctx) {
                contentArea.innerHTML = '<div class="spinner"></div>';

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        let tableHtml = '';

                        if (key === 'users' && Array.isArray(data)) {
                            tableHtml = `
                                <div class="card">
                                    <h2>${title}</h2>
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Username</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${data.slice(0, 10).map(user => `
                                                <tr>
                                                    <td>${user.id}</td>
                                                    <td>${user.name}</td>
                                                    <td>${user.email}</td>
                                                    <td>${user.username}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `;
                        }

                        contentArea.innerHTML = tableHtml || `
                            <div class="card">
                                <h2>${title}</h2>
                                <pre>${JSON.stringify(data, null, 2)}</pre>
                            </div>
                        `;
                    })
                    .catch(error => {
                        contentArea.innerHTML = `
                            <div class="card">
                                <h2>Error</h2>
                                <div class="status-message error">
                                    Failed to load API data: ${error.message}
                                </div>
                            </div>
                        `;
                    });
            }
        }

        // Open static content tab
        function openStaticTab(key, title) {
            openPageInTab(key, title, '#static');

            let content = '';

            switch(key) {
                case 'create':
                    content = `
                        <div class="card">
                            <h2>${title}</h2>
                            <div class="form-group">
                                <label for="postTitle">Title</label>
                                <input type="text" id="postTitle" class="form-control" placeholder="Enter post title">
                            </div>
                            <div class="form-group">
                                <label for="postBody">Content</label>
                                <textarea id="postBody" class="form-control" rows="4" placeholder="Enter post content"></textarea>
                            </div>
                            <button class="btn" onclick="submitPost()">Submit Post</button>
                            <div id="postResult" style="margin-top: 16px;"></div>
                        </div>
                    `;
                    break;
                default:
                    content = `
                        <div class="card">
                            <h2>${title}</h2>
                            <p>This is the ${title} tab.</p>
                        </div>
                    `;
            }

            contentArea.innerHTML = content;
            const ctx = tabs.get(key);
            if (ctx) {
                ctx.isLoaded = true;
                ctx.content = content;
            }
        }

        // Submit post function
        window.submitPost = function() {
            const title = document.getElementById('postTitle').value;
            const body = document.getElementById('postBody').value;
            const resultEl = document.getElementById('postResult');

            if (!title || !body) {
                resultEl.innerHTML = `
                    <div class="status-message error">
                        Please fill in both title and content
                    </div>
                `;
                return;
            }

            resultEl.innerHTML = `
                <div class="status-message success">
                    Post submitted successfully!
                </div>
            `;
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd+W closes active tab
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'w') {
                e.preventDefault();
                if (activeTabKey && activeTabKey !== mvcContentKey) {
                    closeTab(activeTabKey);
                }
            }

            // Ctrl/Cmd+R refreshes active tab
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'r') {
                e.preventDefault();
                if (activeTabKey && activeTabKey !== mvcContentKey) {
                    refreshTab(activeTabKey);
                }
            }
        });

    </script>
</body>
</html>
