<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="~/Content/Images/patrol .ico">
    <meta name="description" content="Learn how to improve your website with caching, accessibility, and SEO best practices.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>San Hydro application</title>
    <link rel="preload" href="@Url.Content("~/Content/fonts/Poppins-Regular.ttf")" as="font" type="font/ttf" crossorigin="anonymous">

    <script src="~/Scripts/bootstrap.min.js"></script>
    <script src="~/Scripts/Popper.min.js"></script>

    @Styles.Render("~/Content/shared-css")
    @Styles.Render("~/Content/patrol-css")

    @Scripts.Render("~/bundles/shared-js")
    @Scripts.Render("~/bundles/modernizr")
</head>
<body>
    <!--========== HEADER ==========-->
    <header class="header">
        <div class="header__container flex_space">
            <a href="#" class="header__logo">San Hydro Application</a>
            <div class="d-flex align-items-center gap-3">
                <div id="notificationBell" style="cursor:pointer; position: relative;">
                    <i class="fa-regular fa-bell"></i>
                    <span id="notificationBadge" style="
                        position: absolute;
                        top: -5px;
                        right: -5px;
                        background: red;
                        color: white;
                        font-size: 10px;
                        width: 16px;
                        height: 16px;
                        display: none;
                        border-radius: 50%;
                        text-align: center;
                        line-height: 16px;
                    ">0</span>
                </div>

                

            
                <span id="UserFullname"></span>
                <img src="~/Content/Images/bussiness-man.png" alt="" class="header__img" />


                <!-- Notification Dropdown -->
                <div id="notificationDropdown" style="
                                                    display: none;
                                                    position: absolute;
                                                    top: 30px;
                                                    right: 0;
                                                    width: 300px;
                                                    max-height: 400px;
                                                    overflow-y: auto;
                                                    background: white;
                                                    box-shadow: 0px 2px 10px rgba(0,0,0,0.2);
                                                    border-radius: 5px;
                                                    z-index: 1000;
                                                ">
                    <ul id="stockAlerts" style="list-style:none; padding:0; margin:0;">
                        <li style="padding:10px; text-align:center; color:gray;">No alerts</li>
                    </ul>
                </div>
            </div>


            <div class="header__toggle">
                <i class="fa-solid fa-location-crosshairs" id="header-toggle"></i>
            </div>
        </div>
    </header>

    <!--========== NAV ==========-->
    <div class="sidebar" id="sidebar">
        <nav class="sidebar__container">
            <div>
                <div class="sidebar__list">
                    <div class="sidebar__items">
                        <h3 class="sidebar__subtitle">Main Menu</h3>
                        <a href="/Hydroponics/Hydro/Orderpage" class="sidebar__link">
                            <i class="fa-regular fa-file-zipper sidebar__icon"></i>
                            <span class="sidebar__name">Request</span>
                        </a>



                        <a href="/Hydroponics/Hydro/Chambers" class="sidebar__link">
                            <i class="fa-regular fa-object-group sidebar__icon"></i>
                            <span class="sidebar__name">Chambers</span>
                        </a>



                        <div class="sidebar__dropdown">
                            <a href="#" class="sidebar__link">
                                <i class="fa-regular fa-circle-user sidebar__icon"></i>
                                <span class="sidebar__name">Manage Parts  <i class="fa-solid fa-caret-down"></i> </span>
                            </a>

                            <div class="sidebar__dropdown-collapse">
                                <div class="sidebar__dropdown-content">
                                    <a href="/Hydroponics/Hydro/PartList" class="sidebar__dropdown-item">Masterlist</a>
                                    <a href="/Hydroponics/Hydro/Inventorylist" class="sidebar__dropdown-item">Stocks</a>
                                    <a href="/P1SA/DieMold/DiePressLife" class="sidebar__dropdown-item">Transaction</a>
                                </div>
                            </div>
                        </div>

                        <a href="#" class="sidebar__link">
                            <i class="fa-solid fa-user sidebar__icon"></i>
                            <span class="sidebar__name">Users</span>
                        </a>

                    </div>

                    <div class="sidebar__items">
                        <h3 class="sidebar__subtitle">Others</h3>

                        @*<div class="nav__dropdown">
                                <a href="#" class="nav__link">
                                    <i class='bx bx-bell nav__icon'></i>
                                    <span class="nav__name">Notifications</span>
                                    <i class='bx bx-chevron-down nav__icon nav__dropdown-icon'></i>
                                </a>

                                <div class="nav__dropdown-collapse">
                                    <div class="nav__dropdown-content">
                                        <a href="#" class="nav__dropdown-item">Blocked</a>
                                        <a href="#" class="nav__dropdown-item">Silenced</a>
                                        <a href="#" class="nav__dropdown-item">Publish</a>
                                        <a href="#" class="nav__dropdown-item">Program</a>
                                    </div>
                                </div>

                            </div>*@


                        <a href="/PC/Patrol/Settings" class="sidebar__link">
                            <i class="fa-solid fa-gear sidebar__icon"></i>
                            <span class="sidebar__name">Settings</span>
                        </a>
                    </div>
                </div>
            </div>

            <a href="#" id="logID" class="sidebar__link sidebar__logout">
                <i class="fa-solid fa-right-from-bracket sidebar__icon"></i>
                <span class="sidebar__name">Log Out</span>
            </a>
        </nav>
    </div>
    <div id="stockAlertsContainer">
        <ul id="stockAlerts"></ul>
    </div>

    <!--========== CONTENTS ==========-->
    <main>
        @RenderBody()
    </main>


    <script type="text/javascript">



        const GetNotification = async () => {
            let res = await FetchAuthenticate('@Url.Action("GetNotificationList", "Notification")', {});
            if (res && res.Success) {

            }
        }
        const GetFullname = async () => {
            var x = localStorage.getItem("Fullname") || "Guest user";
            $("#UserFullname").text(x);
        };



        const logbtn = document.getElementById("logID");

        /*==================== SHOW NAVBAR ====================*/
        const showMenu = (headerToggle, navbarId) => {
            const toggleBtn = document.getElementById(headerToggle),
                nav = document.getElementById(navbarId)

            // Validate that variables exist
            if (headerToggle && navbarId) {
                toggleBtn.addEventListener('click', () => {
                    // We add the show-menu class to the div tag with the nav__menu class
                    nav.classList.toggle('show-menu')
                    // change icon
                    toggleBtn.classList.toggle('fa-solid')
                })
            }
        }
        showMenu('header-toggle', 'sidebar')

        /*==================== LINK ACTIVE ====================*/
        const linkColor = document.querySelectorAll('.sidebar__link')

        function colorLink() {
            linkColor.forEach(l => l.classList.remove('active'))
            this.classList.add('active')
        }

        linkColor.forEach(l => l.addEventListener('click', colorLink))



        document.addEventListener("DOMContentLoaded", function () {
            var currentUrl = window.location.pathname.toLowerCase();
            document.querySelectorAll(".sidebar__link").forEach(function (link) {
                if (link.getAttribute("href").toLowerCase() === currentUrl) {
                    link.classList.add("active");
                }
            });
        });


        logbtn.addEventListener('click', function (e) {
            e.preventDefault();
            Swal.fire({
                title: "Sign out ?",
                text: "Are you sure you want to sign out?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#a3a3a3",
                confirmButtonText: "Log out"
            }).then((result) => {
                /* Read more about isConfirmed, isDenied below */
                if (result.isConfirmed) {
                    localStorage.removeItem("Fullname");
                    localStorage.removeItem("UserRole");
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    logout();
                }
            });
        });


        $(document).ready(function () {
            // Toggle dropdown
            $("#notificationBell").click(function (e) {
                $("#notificationDropdown").toggle();
                // Clear badge when user opens
                $("#notificationBadge").text('0').hide();
            });


            // Hide dropdown if clicking outside
            $(document).click(function (e) {
                if (!$(e.target).closest("#notificationBell, #notificationDropdown").length) {
                    $("#notificationDropdown").hide();
                }
            });

            let lastCheck = null;

             // Polling function
           async function pollStockAlerts() {
                try {
                    const response = await $.ajax({
                        url: '@Url.Action("GetStockAlerts", "Hydro")',
                        type: 'GET',
                        dataType: 'json'
                    });
                    console.log(response);
                    if (response.Success) {
                        const container = $("#stockAlerts");
                        container.empty();

                        if (!response.Alerts || response.Alerts.length === 0) {
                            container.append('<li style="padding:10px; text-align:center; color:gray;">No alerts</li>');
                            $("#notificationBadge").hide();
                        } else {
                            response.Alerts.forEach(alert => {
                                container.append(
                                    `<li style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;"
                                         onclick="window.location='/Hydroponics/Hydro/Inventorylist'">
                                        <strong>${alert.PartName}</strong> is low! (${alert.CurrentQty} left)
                                    </li>`
                                );
                            });

                            // Update badge count
                            $("#notificationBadge").text(response.Alerts.length).show();
                        }
                    }
                } catch (error) {
                    console.warn("Error fetching stock alerts:", error);
                }
            }

            // Start polling every 15 seconds
            pollStockAlerts(); // initial load
            setInterval(pollStockAlerts, 15000); // 15s interval
        });







        GetFullname();
        //GetNotification();

        window.IsLoginUser({
            storageKey: "isLoggedInHydro",
            redirectUrl: '/Hydroponics/Hydro/Inventorylist',
            expectedValue: 'true',
            expirationKey: 'HydroTime',
            maxHours: 24
        });
    </script>


</body>
</html>
