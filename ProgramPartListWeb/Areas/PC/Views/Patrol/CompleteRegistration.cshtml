
@{
    Layout = null;
    var regno = Request.QueryString["Regno"];
}


<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="@Url.Content("~/Content/Images/patrol .ico")">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>@ViewBag.Title</title>
    <link rel="preload" href="~/Content/fonts/Poppins-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">


    <link href="~/Content/Shared/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/css/RegistrationUI.css" rel="stylesheet" />

    @Styles.Render("~/Content/shared-css")

    @Scripts.Render("~/bundles/shared-js")
    @Scripts.Render("~/bundles/modernizr")
</head>


<body>
    <div class="MainWrapper">

        <div class="sidebar">
            <h2><i>📄</i><span id="regtext"></span></h2>
            <ul class="step-list">
                <li class="step-item active" data-step="1">
                    <span class="step-number">1</span>
                    Create new
                </li>
                <li class="step-item" data-step="2">
                    <span class="step-number">2</span>
                    Process Owner
                </li>
                <li class="step-item" data-step="3">
                    <span class="step-number">3</span>
                    Inspectors
                </li>
                <li class="step-item" data-step="4">
                    <span class="step-number">4</span>
                    Managers
                </li>
                @*<li class="step-item" data-step="5">
                        <span class="step-number">5</span>
                        Department Managerss
                    </li>*@
                <li class="step-item" data-step="5">
                    <span class="step-number">5</span>
                    Division Manager
                </li>
                <li class="step-item" data-step="6">
                    <span class="step-number">6</span>
                    Completed
                </li>
            </ul>
        </div>

        <div class="content">

            <!-- Step 1: Create New Document -->
            <div class="step-content active" id="step-1">

            </div>

            <!-- Step 2: Person in Charge -->
            <div class="step-content" id="step-2">

            </div>

            <!-- Step 3: Document Details -->
            <div class="step-content" id="step-3">

            </div>

            <!-- Step 4: Attachments -->
            <div class="step-content" id="step-4">

            </div>

            <!-- Step 5: Review & Submit -->
            <div class="step-content" id="step-5">

            </div>

            <!-- Step 6: Review & Submit -->
            <form method="post" enctype="multipart/form-data" class="step-content active" style="padding: 1.5em 0;" id="step-6" autocomplete="off">
                <div class="row">
                    <div class="col-12">
                        <div class="Attachmentcontainer mb-3">

                            <label class="mb-0 fw-bold">Attachments : </label>
                            <div id="fileContainer"></div>

                        </div>


                        <div class="row mb-3">
                            <div class="col">
                                <label>Registration No.  </label> <br />
                                <input type="text" id="Regno" value="@regno" name="Regno" readonly />
                                <input type="hidden" name="Filepath" id="Filepath" />

                            </div>
                            <div class="col">
                                <label>Department / Section  </label> <br />
                                <input type="text" id="SectionName" readonly />
                            </div>
                        </div>






                        <h5 class="mb-4 mt-4 fw-bold">Inspection Criterion / Findings</h5>
                        <hr />
                        <div class="row mb-3">
                            <div class="col ">
                                <label>1. Work Practice / Standard / Safety</label> <br />
                                <input type="hidden" value="1" id="Find1" name="Find1" />
                                <textarea placeholder="Type text here..." name="Inpects1" id="Inpects1" rows="3" cols="40" readonly></textarea>
                            </div>

                            <div class="col ">
                                <label>Countermeasures</label> <br />
                                <textarea placeholder="Type text here..." name="counter1" id="counter1" rows="3" cols="40" readonly></textarea>
                            </div>
                        </div>




                        <div class="row mb-3">
                            <div class="col ">
                                <label>2. Identification and status of the product or materials.</label> <br />
                                <input type="hidden" value="2" id="Find2" name="Find2" required />
                                <textarea placeholder="Type text here..." name="Inpects2" id="Inpects2" rows="3" cols="40" readonly></textarea>
                            </div>

                            <div class="col ">
                                <label>Countermeasures</label> <br />
                                <textarea placeholder="Type text here..." name="counter2" id="counter2" rows="3" cols="40" readonly></textarea>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col ">
                                <label>3. Condition and status of documents / records.</label> <br />
                                <input type="hidden" value="3" id="Find3" name="Find3" required />
                                <textarea placeholder="Type text here..." name="Inpects3" id="Inpects3" rows="3" cols="40" readonly></textarea>
                            </div>

                            <div class="col ">
                                <label>Countermeasures</label> <br />
                                <textarea placeholder="Type text here..." name="counter3" id="counter3" rows="3" cols="40" readonly> </textarea>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col ">
                                <label>4. Record of ‘start-up process check’ and monthly inspection</label> <br />
                                <input type="hidden" value="4" id="Find4" name="Find4" required />
                                <textarea placeholder="Type text here..." name="Inpects4" id="Inpects4" rows="3" cols="40" readonly></textarea>
                            </div>

                            <div class="col ">
                                <label>Countermeasures</label> <br />
                                <textarea placeholder="Type text here..." name="counter4" id="counter4" rows="3" cols="40" readonly></textarea>
                            </div>
                        </div>


                        <div class="row mb-3">
                            <div class="col ">
                                <label>5. Calibration of equipment and jigs used for measurement or inspection.</label> <br />
                                <input type="hidden" value="5" id="Find5" name="Find5" required />
                                <textarea placeholder="Type text here..." name="Inpects5" id="Inpects5" rows="3" cols="40" readonly></textarea>
                            </div>

                            <div class="col ">
                                <label>Countermeasures</label> <br />
                                <textarea placeholder="Type text here..." name="counter5" id="counter5" rows="3" cols="40" readonly></textarea>
                            </div>
                        </div>



                        <div class="row mb-3">
                            <div class="col ">
                                <label>6. Countermeasure and implementation of previous quality and safety</label> <br />
                                <input type="hidden" value="6" id="Find5" name="Find6" required />
                                <textarea placeholder="Type text here..." name="Inpects6" id="Inpects6" rows="3" cols="40" readonly></textarea>
                            </div>

                            <div class="col ">
                                <label>Countermeasures</label> <br />
                                <textarea placeholder="Type text here..." name="counter6" id="counter6" rows="3" cols="40" readonly></textarea>
                            </div>
                        </div>


                        @*<div class="row mb-3">
                            <div class="col ">
                                <label>Inspector Name: </label> <br />
                                <input type="text" id="InspectorName" readonly />
                            </div>

                            <div class="col ">
                                <label>Date Conducted</label> <br />
                                <input type="text" id="DateConduct" readonly />
                            </div>
                        </div>*@

                        @*<div class="mb-3">
                            <label>Person in charge </label> <br />
                            <input type="text" id="PICName" readonly />
                        </div>*@

                        <div class="mb-3">
                            <label>PIC Comments</label>
                            <textarea placeholder="Type text here..." name="PIC_Comments" id="PIC_Comments" rows="3" cols="40" readonly></textarea>
                        </div>
                        <div class="mb-3">
                            <label>Manager Comments</label>
                            <textarea placeholder="Type text here..." name="Manager_Comments" id="Manager_Comments" rows="3" cols="40" readonly></textarea>
                        </div>

                    </div>
                </div>


                <div class="approval-container">
                    <div class="approval-box">
                        <div class="approval_title" id="PIC_approve">LA Datu</div>
                        <div class="approval_content">
                            <p class="approval_status approved" id="PIC_Isapprove">Approved</p>

                        </div>
                        <div class="approval_role">Person In Charge</div>
                    </div>

                    <div class="approval-box">
                        <div class="approval_title" id="Inspect_approve">Lionell Gomez</div>
                        <div class="approval_content">
                            <p class="approval_status approved" id="Ins_Isapprove">Approved</p>
                        </div>
                        <div class="approval_role">Inspector</div>
                    </div>

                    <div class="approval-box">
                        <div class="approval_title" id="Dep_approve">LA Datu</div>
                        <div class="approval_content">
                            <p class="approval_status approved" id="Dep_Isapprove">Approved</p>
                        </div>
                        <div class="approval_role">Department Manager</div>
                    </div>

                    <div class="approval-box">
                        <div class="approval_title" id="Div_approve">LA Datu</div>
                        <div class="approval_content">
                            <p class="approval_status approved" id="Div_Isapprove">Approved</p>
                        </div>
                        <div class="approval_role">Division Manager</div>
                    </div>
                </div>

            </form>
        </div>


    </div>




    <div class="float-container" id="floatContainer">
        <div class="float-header">
            <h2>For Approval</h2>
            <button class="close-btn" id="closeBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="commentForm">


            <div class="form-group">
                <label for="moderation-notes">Comments for Return (Optional)</label>
                <textarea rows="4" id="Return_Comments" name="Return_Comments" placeholder="Send Message Back ..."></textarea>
            </div>

            <div class="action-buttons">
                <button type="button" class="return-btn" id="returnBtn">
                    <i class="fas fa-undo"></i> Return
                </button>
                <button type="button" class="approve-btn" id="approveBtn">
                    <i class="fas fa-check"></i> Approve
                </button>
            </div>
        </form>
    </div>







    <script type="text/javascript">
        let currentStep = 6;
        const totalSteps = 6;



        let strRegno = $("#Regno").val();

        function goToStep(step) {
            // Update current step
            currentStep = step;



            // Update sidebar step states
            document.querySelectorAll('.step-item').forEach((item, index) => {
                const stepNumber = index + 1;

                // Completed (previous steps)
                if (stepNumber < step) {
                    item.classList.add('completed');
                    item.classList.remove('active', 'disabled');
                }
                // Active (current step)
                else if (stepNumber === step) {
                    item.classList.add('active');
                    item.classList.remove('completed', 'disabled');
                }
                // Locked (future steps)
                else {
                    item.classList.add('disabled');
                    item.classList.remove('active', 'completed');
                }
            });

            // Show/hide step content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step-${step}`).classList.add('active');
        }

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function () {
            goToStep(6);

            // Add click event to sidebar steps
            document.querySelectorAll('.step-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    return;
                });
            });
        });

       
         const GetRegistrationDetails = async () => {
             let res = await GetMethod('@Url.Action("GetRegistrationNoDetails", "Patrol")', { Regno: strRegno });
                 if (res && res.Success) {
                     $("#regtext").text(strRegno);
                     //$("#InspectorName").val(res.Data.InspectName);
                     //$("#PICName").val(res.Data.PICName);
                     //$("#DateConduct").val(res.Data.DateConduct);
                     $("#SectionName").val("P1SA-" + res.Data.SectionName);


                     $("#PIC_Comments").val(res.Data.PIC_Comments);
                     $("#Manager_Comments").val(res.Data.Manager_Comments);


                     $("#PIC_approve").text(res.Data.PICName ?? 'N/A');
                     $("#Inspect_approve").text(res.Data.InspectName ?? 'N/A');
                     $("#Dep_approve").text(res.Data.DepartName ?? 'N/A');
                     $("#Div_approve").text(res.Data.DivName ?? 'N/A');


                     $("#PIC_Isapprove").text(res.Data.PIC_Comments != "" ? 'Approve' : 'Pending');
                     $("#Ins_Isapprove").text(res.Data.Inspect_IsAproved == true ? 'Approve' : 'Pending');
                     $("#Dep_Isapprove").text(res.Data.DepManager_IsAproved == true ? 'Approve' : 'Pending');
                     $("#Div_Isapprove").text(res.Data.DivManager_IsAproved == true ? 'Approve' : 'Pending');

                     // Set colors
                     setStatusColor("#PIC_Isapprove", res.Data.PIC_Comments != "");
                     setStatusColor("#Ins_Isapprove", res.Data.Inspect_IsAproved);
                     setStatusColor("#Dep_Isapprove", res.Data.DepManager_IsAproved);
                     setStatusColor("#Div_Isapprove", res.Data.DivManager_IsAproved);


                 }
             }

            // Utility function to set color
            const setStatusColor = (selector, value) => {
                if (value === true) {
                    $(selector).css("color", "blue");
                } else {
                    $(selector).css("color", "red");
                }
            };

             const GetRegistrationFindingsID = async () => {
                 let res = await GetMethod('@Url.Action("GetRegistrationFindings", "Patrol")', { Regno: strRegno });

                 if (res && res.Success) {
                     res.Data.forEach(item => {
                         $(`#Inpects${item.FindID}`).val(item.FindDescription);
                         $(`#counter${item.FindID}`).val(item.Countermeasure);
                     });
                 }
             }

             const GetRegistratioFiles = async () => {
                 let filesSelect = [];
                 let res = await GetMethod('@Url.Action("GetRegistrationAllFiles", "Patrol")', { Regno: strRegno });
                 if (res.Success && res) {
                     filesSelect = res.Data;

                     let UploadCounterPath = filesSelect[0].CounterPath;

                     if (UploadCounterPath) {
                         let files = UploadCounterPath.split(';');
                         let fileHtml = "";

                         files.forEach(f => {
                             if (f.trim() !== "") {
                                 let filenameonly = f.replace(/\.pdf$/i, "");

                                 const fileExtension = f.split('.').pop().toLowerCase();

                                 let fileType = 'default';

                                 if (['pdf'].includes(fileExtension)) {
                                     fileType = 'pdf';
                                 } else if (['xlsx', 'xls', 'xlsm', 'csv'].includes(fileExtension)) {
                                     fileType = 'xlsx';
                                 } else if (['doc', 'docx', 'txt'].includes(fileExtension)) {
                                     fileType = 'doc';
                                 } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(fileExtension)) {
                                     fileType = 'img';
                                 } else if (['zip', 'rar', '7z'].includes(fileExtension)) {
                                     fileType = 'zip';
                                 }

                                 const fileIconClass = `file-icon ${fileType}`;


                                 let fileIcon = '';

                                 switch (fileType) {
                                     case 'pdf':
                                         fileIcon = '<i class="far fa-file-pdf"></i>';
                                         break;
                                     case 'doc':
                                         fileIcon = '<i class="far fa-file-word"></i>';
                                         break;
                                     case 'img':
                                         fileIcon = '<i class="far fa-file-image"></i>';
                                         break;
                                     case 'zip':
                                         fileIcon = '<i class="far fa-file-archive"></i>';
                                         break;
                                     case 'xlsx':
                                         fileIcon = '<i class="fa-regular fa-file-excel"></i>';
                                         break;
                                     default:
                                         fileIcon = '<i class="far fa-file"></i>';
                                 }

                                 fileHtml += `
                                      <button class="open-pdf-btn" data-pdf-url="/Patrol/ViewPDF?strfilepath=${f}">
                                           <div class="${fileIconClass}">
                                             ${fileIcon}
                                           </div>
                                           <div class="file-info">
                                               <div class="file-name">${filenameonly}</div>
                                           </div>
                                    </button>
                                 `;
                             }
                         });

                         document.getElementById("fileContainer").innerHTML = fileHtml;

                         // Attach click event
                         document.querySelectorAll(".open-pdf-btn").forEach(btn => {
                             btn.addEventListener("click", function () {
                                 let pdfUrl = this.getAttribute("data-pdf-url");
                                 window.open(pdfUrl, "_blank"); // Open in new tab
                             });
                         });
                     }


                 }

             }


        // ############## DISPLAY ALL THE DATA TO THE PAGE ########################
        const LoadPageData = async () => {
            try {

                const [regist, find, files] = await Promise.all([
                    GetRegistrationDetails(),
                    GetRegistrationFindingsID(),
                    GetRegistratioFiles()
                ]);
            } catch (error) {
                console.error("Failed to load page data:", error);
            } finally {
                // Hide loading spinner whether success or failure
                //$("#loadingSpinner").hide();
            }
        }

        $(document).ready(() => {
            LoadPageData();
        });
    </script>
</body>

