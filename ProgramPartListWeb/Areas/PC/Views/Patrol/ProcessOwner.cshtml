
@{
    Layout = null;
    var regno = Request.QueryString["Regno"];
}

<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="@Url.Content("~/Content/Images/patrol .ico")">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>@ViewBag.Title</title>
    <link rel="preload" href="~/Content/fonts/Poppins-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">


    <link href="~/Content/Shared/bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/css/RegistrationUI.css" rel="stylesheet" />

    @Styles.Render("~/Content/shared-css")

    @Scripts.Render("~/bundles/shared-js")
    @Scripts.Render("~/bundles/modernizr")
</head>


<body>
    <div class="MainWrapper">

        <div class="sidebar">
            <h2><i>📄</i><span id="regtext">@regno</span></h2>
            <ul class="step-list">
                <li class="step-item active" data-step="1">
                    <span class="step-number">1</span>
                    Create new
                </li>
                <li class="step-item" data-step="2">
                    <span class="step-number">2</span>
                    Process Owner
                </li>

                <li class="step-item" data-step="3">
                    <span class="step-number">3</span>
                    Managers
                </li>

                <li class="step-item" data-step="4">
                    <span class="step-number">4</span>
                    Division Manager
                </li>
                <li class="step-item" data-step="5">
                    <span class="step-number">5</span>
                    Completed
                </li>
            </ul>
        </div>

        <div class="content">


            <!-- Step 1: Create New Document -->
            <div class="step-content active" id="step-1">

            </div>

            <!-- Step 2: Person in Charge -->
            <form method="post" enctype="multipart/form-data" class="step-content active" style="padding: 1.5em 0;" id="step-2" autocomplete="off">



                <div class="row mb-3">
                    <div class="col">
                        <label>Registration No.  </label> <br />
                        <input type="text" id="RegNo" class="mt-2" value="@regno" name="RegNo" readonly />
                    </div>
                    <div class="col">
                        <label>Department / Section  </label> <br />
                        <input type="text" id="SectionName" class="mt-2" readonly />
                    </div>
                </div>


                <hr />


                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>1. Work Practice / Standard / Safety</label> <br />

                    <p id="Inpects1"></p>


                    <textarea placeholder="Type text here..." name="counter1" id="counter1" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>2. Identification and status of the product or materials.</label> <br />
                    <p id="Inpects2"></p>
                    <textarea placeholder="Type text here..." name="counter2" id="counter2" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>3. Condition and status of documents / records.</label> <br />
                    <p id="Inpects3"></p>
                    <textarea placeholder="Type text here..." name="counter3" id="counter3" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>4. Record of ‘start-up process check’ and monthly inspection</label> <br />
                    <p id="Inpects4"></p>
                    <textarea placeholder="Type text here..." name="counter4" id="counter4" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>5. Calibration of equipment and jigs used for measurement or inspection.</label> <br />
                    <p id="Inpects5"></p>
                    <textarea placeholder="Type text here..." name="counter5" id="counter5" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>6. Countermeasure and implementation of previous quality and safety</label> <br />
                    <p id="Inpects6"></p>
                    <textarea placeholder="Type text here..." name="counter6" id="counter6" rows="3" cols="40"></textarea>
                </div>
                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>PIC Comments</label>
                    <textarea placeholder="Type text here..." name="PIC_Comments" id="PIC_Comments" rows="3" cols="40"></textarea>
                </div>




                <div class="Attachmentcontainer col-12 col-sm-12 col-lg-12 mb-3">
                    <label class="mb-2 mt-2 fw-bold">Upload Attachments : </label><br />


                    <div class="file-upload" id="file-upload-area">
                        <p>Click to upload files or drag and drop</p>
                        <input type="file" id="file-input" multiple style="display: none;">
                    </div>



                    <div class="Attachmentcontainer mt-3">

                        <div id="fileContainer"></div>
                        <ul id="fileList" class="file-list"></ul>
                    </div>

                </div>

                <hr />

                <div class="col-4 col-sm-12 col-lg-4 mb-3">
                    <label>Person Incharge signature</label>  <br />

                    <div class="signature-container" id="signature-display">
                        <div class="signature-placeholder" id="placeholder">
                            <i class="fas fa-signature" style="font-size: 48px; margin-bottom: 15px; color: #bdc3c7;"></i>
                            <p>No Signature Display Please Upload</p>
                        </div>
                        <img id="signature-image" class="signature-image" style="display: none;">

                        <div class="signature-Input" id="signature-Input" style="display: none;">
                            <i class="fas fa-signature" style="font-size: 48px; margin-bottom: 15px; color: #bdc3c7;"></i>
                            <p> No Signature Found. Please upload by click the Circle Icon. </p>
                        </div>

                    </div>

                    <button id="uploadSig" class="btn btn-primary text-light mt-2">Update Signation</button>
                </div>


                <div class="button-group">
                    <div></div> <!-- Empty div for spacing -->
                    <button type="submit" id="btnSave"><i class="fa-regular fa-floppy-disk"></i> Approved & Send Email</button>
                </div>
            </form>

            <!-- Step 3: Document Details -->
            <div class="step-content" id="step-3">

            </div>

            <!-- Step 4: Attachments -->
            <div class="step-content" id="step-4">

            </div>

            <!-- Step 5: Review & Submit -->
            <div class="step-content" id="step-5">

            </div>
        </div>


    </div>


    <!-- Sequential Loader -->
    <div id="loader" class="loader-overlay">
        <div class="loader-box">
            <div class="loader-title">Updating Registration No...</div>

            <div class="progress-container">
                <div class="progress-bar" style="background: #f5f5f5;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>

            <div class="step-list">
                <div class="step" id="step1">
                    <div class="step-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="step-contentloader">
                        <div class="step-title">Updating the Database</div>
                        <div class="step-description">Submitting approval data to the system</div>
                    </div>
                </div>

                <div class="step" id="step2">
                    <div class="step-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="step-contentloader">
                        <div class="step-title">Send Email to the Inspectors</div>
                        <div class="step-description">Notifying the review team</div>
                    </div>
                </div>

                <div class="step" id="step3">
                    <div class="step-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="step-contentloader">
                        <div class="step-title">Send Message Success</div>
                        <div class="step-description">Confirming submission completion</div>
                    </div>
                </div>

                <div class="step" id="step4">
                    <div class="step-icon">
                        <i class="fas fa-flag-checkered"></i>
                    </div>
                    <div class="step-contentloader">
                        <div class="step-title">Done and Close</div>
                        <div class="step-description">Process completed successfully</div>
                    </div>
                </div>
            </div>

            <button class="done-btn" id="doneBtn"><i class="fa-solid fa-check"></i> Done</button>
        </div>
    </div>



    <!--########################## UPLOAD DATA #############################-->
    <div class="modal fade modal-lg " id="uploadmodal" data-keyboard="false" data-backdrop="static" tabindex="-1" role="dialog"
         data-bs-backdrop="static"
         aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body modalwrap">
                    <div class="custom_modal_header">
                        <div class="custom_modal__icon">
                            <div class="custom_icon_container">
                                <i class="fa-solid fa-file-import"></i>
                            </div>
                            <div class="custom_modal_title">
                                <span style="font-weight: 600;">Upload your Signature</span>
                            </div>
                        </div>

                        <button type="button" class="btn btn-light  close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>


                    <div class="custom_modal_body">

                        <div class="Mold_tabcontainer">
                            <div class="Mold_tabs">
                                <button class="Mold_tab active" data-target="UploadImage">Write Signature</button>
                                <button class="Mold_tab" data-target="WriteTable">Upload Image</button>
                                <div class="Mold_slider"></div>
                            </div>

                            <div class="Mold_contentbox">
                                <div class="Mold_content show" id="UploadImage">
                                    <div class="row">
                                        <div class="col-6">
                                            <span>Draw a Signature :</span>
                                            <canvas id="signature-pad" width="400" height="200" style="border:1px solid #ccc;"></canvas>
                                        </div>
                                        <div class="col-6">
                                            <form class="SignatureAction" id="SignatureForms">
                                                <input type="hidden" id="SignatureData" name="SignatureData" />

                                                <button type="button" class="clearbtn" onclick="clearSignature()"><i class="fa-solid fa-eraser"></i> Clear</button>
                                                <button type="submit" class="primarybtn"><i class="fa-regular fa-floppy-disk"></i> Save</button>
                                            </form>
                                        </div>
                                    </div>
                                    @* Hidden input to hold the base64 image *@
                                </div>
                                <div class="Mold_content" id="WriteTable">
                                    <form method="post" enctype="multipart/form-data" id="ImportExcel">
                                        <div class="upload-container flex_center" id="upload-container">
                                            <div class="upload-icon">📷</div>
                                            <div class="file-info">Upload a photo of your signature.<br>Max file size: 1MB<br>png, jpg, jpeg, bmp, gif</div>
                                            <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.bmp,.gif" class="hidden">
                                            <button class="upload-btn" id="uploadBtn">Upload Photo</button>
                                        </div>

                                    </form>

                                    <div class="preview-container" id="previewContainer">
                                        <img id="SignatureImage" class="SignatureImage" src="/Content/Images/bussiness-man.png" alt="Signature" style="display: hidden;" />
                                        <img id="previewImage" class="preview-image" src="" alt="Signature Preview">
                                    </div>

                                    <footer class="flex_end">
                                        <span id="Upload "></span>
                                        <button class="primarybtn flex_end" id="saveBtn"><i class="fa-regular fa-floppy-disk"></i> Save</button>
                                    </footer>
                                </div>
                            </div>
                        </div>




                    </div>
                </div>

            </div>
        </div>
    </div>


    <script src="~/Scripts/bootstrap.min.js"></script>
    <script src="~/Scripts/Popper.min.js"></script>
    <script src="~/Scripts/signature_pad.umd.min.js"></script>
    <script type="text/javascript">
        let currentStep = 2;
        const totalSteps = 5;
        let selectedFiles = [];
        let emailTable = [];

        let strRegno = "@regno";
        let modeset = @ViewBag.Mode;
        let strPIC;
        // =======  FOR UPLOADING FILES =======================
        const fileUploadArea = document.getElementById("file-upload-area");
        const fileList = document.getElementById("fileList");
        const fileInput = document.getElementById("file-input");
        // ====================================================

        const addform = document.getElementById("step-2");
        const signatureImage = document.getElementById('signature-image');
        const signatureInput = document.getElementById('signature-Input');
        const placeholder = document.getElementById('placeholder');

        function goToStep(step) {
            // Update current step
            currentStep = step;


            // Update sidebar step states
            document.querySelectorAll('.step-item').forEach((item, index) => {
                const stepNumber = index + 1;

                // Completed (previous steps)
                if (stepNumber < step) {
                    item.classList.add('completed');
                    item.classList.remove('active', 'disabled');
                }
                // Active (current step)
                else if (stepNumber === step) {
                    item.classList.add('active');
                    item.classList.remove('completed', 'disabled');
                }
                // Locked (future steps)
                else {
                    item.classList.add('disabled');
                    item.classList.remove('active', 'completed');
                }
            });


            // Show/hide step content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step-${step}`).classList.add('active');
        }

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function () {
            goToStep(2);

            // Add click event to sidebar steps
            document.querySelectorAll('.step-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    return;
                });
            });
        });


        const findingsJson = (e) => {
            let formData = new FormData(e);
            const data = Object.fromEntries(formData);

            const findings = [];

            for (let i = 1; i <= 6; i++) {
                findings.push({
                    RegNo: strRegno,
                    FindID: i,
                    Countermeasure: data[`counter${i}`]
                });
            }


            return JSON.stringify(findings);
        };

        signatureInput.addEventListener('click', function () {
            $("#uploadmodal").modal('show');
        });

        $("#uploadSig").on('click', function (e) {
            e.preventDefault();
            $("#uploadmodal").modal('show');
        });



        addform.addEventListener('submit', async (e) => {
             e.preventDefault();

                 // Get the ID of the save button and Store original text
                 //const savebtn = document.querySelector("#btnSave");
                 //const originalText = savebtn.innerHTML;

                 // Create loading icon and message container
                 //savebtn.disabled = true;
                 //savebtn.innerHTML = `<div class='buttonloading'></div><span id='loadingSequence'>Saving data...</span>`;

                 // Append form data
                 let strfind = findingsJson(e.target);
                 let finalformData = new FormData(e.target);
                 finalformData.append('FindJson', strfind);
                 // ✅ Add multiple attachments
                 selectedFiles.forEach(file => {
                     finalformData.append("Attachments", file);
                 });

                 // For registration validation, read RegNo from form data
                 const finaldata = Object.fromEntries(finalformData);

                // Show loader
                document.getElementById('loader').classList.add('active');

                // Reset steps
                resetSteps();

                let res = await postData('@Url.Action("ProcessOwnerSubmission", "Patrol")', finalformData);

                if (res && res.Success) {
                    // Start the sequential loading process
                    startSequentialLoading();
                } else {
                    // Reset button if failed
                    document.querySelector("#loadingSequence").textContent = "Failed. Please try again.";
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }

                 @*// Step 1: Simulate "Saving data..."
                 await new Promise(resolve => setTimeout(resolve, 1200)); // 1.2s delay for animation

                 // Step 2: Update loading text
                 document.querySelector("#loadingSequence").textContent = "Sending email to the inspector...";
                 await new Promise(resolve => setTimeout(resolve, 1200));

                 // Step 3: Send data to the controller
                 let res = await postData('@Url.Action("ProcessOwnerSubmission", "Patrol")', finalformData);

                 if (res && res.Success) {
                     document.querySelector("#loadingSequence").textContent = "Done ✅";
                     await new Promise(resolve => setTimeout(resolve, 1000));
                     savebtn.innerHTML = originalText;
                 } else {
                     // Reset button if failed
                     document.querySelector("#loadingSequence").textContent = "Failed. Please try again.";
                     await new Promise(resolve => setTimeout(resolve, 2000));
                     savebtn.innerHTML = originalText;
                     savebtn.disabled = false;
                 }*@

         });



        fileUploadArea.addEventListener("click", () => fileInput.click());
        // =================== MULTIPLE UPLOAD FILES ==============================
        fileInput.addEventListener("change", function () {
            // Add new files to the array (avoid duplicates by name+size)
            for (let file of fileInput.files) {
                let exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    selectedFiles.push(file);
                }
            }
            renderFileList();
            fileInput.value = ""; // reset input to allow re-upload of same file
        });


        function renderFileList() {
            fileList.innerHTML = "";
            selectedFiles.forEach((file, index) => {
                const div = document.createElement("div");
                div.classList.add("pdf-container");

                const pdfBtn = document.createElement("button");
                pdfBtn.classList.add("open-pdf-btn");
                pdfBtn.innerHTML = `<i class="fa-solid fa-file-pdf"></i> ${file.name}`;
                pdfBtn.onclick = () => {
                    const fileURL = URL.createObjectURL(file);
                    window.open(fileURL, "_blank");
                };

                const removeBtn = document.createElement("button");
                removeBtn.classList.add("remove-btn");
                removeBtn.innerHTML = `<i class="fa-regular fa-circle-xmark"></i>`;
                removeBtn.onclick = () => {
                    selectedFiles.splice(index, 1);
                    renderFileList();
                };

                div.appendChild(pdfBtn);
                div.appendChild(removeBtn);
                fileList.appendChild(div);
            });
        }

        const GetRegistrationDetails = async () => {
            let res = await fetchData('@Url.Action("GetRegistrationNoDetails", "Patrol")', { Regno: strRegno });
            if (res && res.Success) {
                $("#regtext").text(strRegno);
                $("#SectionName").val("P1SA-" + res.Data.SectionName);
                $("#PIC_Comments").val(res.Data.PIC_Comments);
                strPIC = res.Data.PIC_ID;

                let Getitems = emailTable.find(res => res.Employee_ID === strPIC);
                if (Getitems) {
                    if (Getitems.Signature) {
                        // Display the Signature Image
                        placeholder.style.display = 'none';
                        signatureInput.style.display = 'none';
                        signatureImage.style.display = 'block';
                        signatureImage.src = '/User/GetSignatureImage?filename=' + encodeURIComponent(Getitems.Signature);
                    } else {
                        // If No Signature Image
                        placeholder.style.display = 'none';
                        signatureImage.style.display = 'none';
                        signatureInput.style.display = 'block';
                    }
                }
            }
        }

        const GetRegistrationID = async () => {
            let res = await fetchData('@Url.Action("GetRegistrationFindings", "Patrol")', { Regno: strRegno });

            if (res && res.Success) {
                res.Data.forEach(item => {
                    $(`#Inpects${item.FindID}`).text("- " + item.FindDescription);
                    $(`#counter${item.FindID}`).val(item.Countermeasure);
                });
            }
        }

        const GetRegistratioFiles = async () => {
            let filesSelect = [];

            if (modeset != 0) {
                return;
            }

            $("#file-upload-area").hide();   

             let res = await fetchData('@Url.Action("GetRegistrationAllFiles", "Patrol")', { Regno: strRegno });
             if (res.Success && res) {
                 filesSelect = res.Data;

                 let UploadCounterPath = filesSelect[0].CounterPath;

                 if (UploadCounterPath) {
                     let files = UploadCounterPath.split(';');
                     let fileHtml = "";

                     files.forEach(f => {
                         if (f.trim() !== "") {
                             let filenameonly = f.replace(/\.pdf$/i, "");

                             const fileExtension = f.split('.').pop().toLowerCase();

                             let fileType = 'default';

                             if (['pdf'].includes(fileExtension)) {
                                 fileType = 'pdf';
                             } else if (['xlsx', 'xls', 'xlsm', 'csv'].includes(fileExtension)) {
                                 fileType = 'xlsx';
                             } else if (['doc', 'docx', 'txt'].includes(fileExtension)) {
                                 fileType = 'doc';
                             } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(fileExtension)) {
                                 fileType = 'img';
                             } else if (['zip', 'rar', '7z'].includes(fileExtension)) {
                                 fileType = 'zip';
                             }

                             const fileIconClass = `file-icon ${fileType}`;


                             let fileIcon = '';

                             switch (fileType) {
                                 case 'pdf':
                                     fileIcon = '<i class="far fa-file-pdf"></i>';
                                     break;
                                 case 'doc':
                                     fileIcon = '<i class="far fa-file-word"></i>';
                                     break;
                                 case 'img':
                                     fileIcon = '<i class="far fa-file-image"></i>';
                                     break;
                                 case 'zip':
                                     fileIcon = '<i class="far fa-file-archive"></i>';
                                     break;
                                 case 'xlsx':
                                     fileIcon = '<i class="fa-regular fa-file-excel"></i>';
                                     break;
                                 default:
                                     fileIcon = '<i class="far fa-file"></i>';
                             }

                             fileHtml += `
                                   <button class="open-pdf-btn" data-pdf-url="/Patrol/ViewPDF?strfilepath=${f}">
                                        <div class="${fileIconClass}">
                                          ${fileIcon}
                                        </div>
                                        <div class="file-info">
                                            <div class="file-name">${filenameonly}</div>
                                        </div>
                                 </button>
                              `;
                         }
                     });

                     document.getElementById("fileContainer").innerHTML = fileHtml;

                     // Attach click event
                     document.querySelectorAll(".open-pdf-btn").forEach(btn => {
                         btn.addEventListener("click", function () {
                             let pdfUrl = this.getAttribute("data-pdf-url");
                             window.open(pdfUrl, "_blank"); // Open in new tab
                         });
                     });
                 }


             }

 }


        const GetEmailList = async () => {
            let res = await fetchData('@Url.Action("GetEmaiRegistration", "Patrol")', {});
            if (res && res.Success) {
                emailTable = res.Data;
            }
        };


        const RedirectPageView = (stats, regno, mode) => {
            if (stats == 1) return;
            // Use encodeURIComponent to avoid issues with special characters
            const r = encodeURIComponent(regno);
            const m = encodeURIComponent(mode);

            switch (stats) {
                case 1:
                    window.location.href = `/PC/Patrol/ProcessOwner?Regno=${r}&mode=${m}`;
                    break;
                case 2:
                    window.location.href = `/PC/Patrol/InspectorsReview?Regno=${r}&mode=${m}`;
                    break;
                case 3:
                    window.location.href = `/PC/Patrol/ManagerView?Regno=${r}&mode=${m}`;
                    break;
                case 4:
                case 5:
                case 6:
                    window.location.href = `/PC/Patrol/DepartmentApproval?Regno=${r}&mode=${m}`;
                    break;
                default:
                    console.warn("Unknown status:", stats);
            }
        };

         // ############## DISPLAY ALL THE DATA TO THE PAGE ########################
         const LoadPageData = async () => {
             try {
                 const [regist, ID, email] = await Promise.all([
                     GetRegistrationDetails(),
                     GetRegistrationID(),
                     GetRegistratioFiles()
                 ]);
             } catch (error) {
                 console.error("Failed to load page data:", error);
             }
         }

         $(document).ready(() => {
             LoadPageData();
             GetEmailList();
         });



        // Loading Submisstion Process

        function resetSteps() {
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => {
                step.classList.remove('active', 'completed');
            });

            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('doneBtn').classList.remove('show');
        }

        function startSequentialLoading() {
            const steps = [
                { id: 'step1', duration: 2000, progress: 25 },
                { id: 'step2', duration: 2500, progress: 50 },
                { id: 'step3', duration: 1500, progress: 75 },
                { id: 'step4', duration: 1000, progress: 100 }
            ];

            let currentStep = 0;

            function processNextStep() {
                if (currentStep >= steps.length) {
                    // All steps completed
                    document.getElementById('doneBtn').classList.add('show');
                    return;
                }

                const step = steps[currentStep];
                const stepElement = document.getElementById(step.id);

                // Activate current step
                stepElement.classList.add('active');

                // Update progress
                document.getElementById('progressFill').style.width = step.progress + '%';
                document.getElementById('progressText').textContent = step.progress + '%';

                // Simulate processing time
                setTimeout(function () {
                    // Mark step as completed
                    stepElement.classList.remove('active');
                    stepElement.classList.add('completed');

                    // Move to next step
                    currentStep++;
                    processNextStep();
                }, step.duration);
            }

            // Start the sequence
            processNextStep();
        }


        document.getElementById('doneBtn').addEventListener('click', function () {
            // Hide loader
            document.getElementById('loader').classList.remove('active');

            window.location.href = `/PC/Patrol/ProcessOwner?Regno=${strRegno}&mode=0`;

        });


        // Tabs Content
        const tabs = document.querySelectorAll(".Mold_tab");
        const slider = document.querySelector(".Mold_slider");
        const contents = document.querySelectorAll(".Mold_content");

        tabs.forEach((tab, index) => {
            tab.addEventListener("click", () => {
                // Handle tab active class
                document.querySelector(".Mold_tab.active").classList.remove("active");
                tab.classList.add("active");

                // Move slider
                slider.style.transform = `translateX(${index * 100}%)`;

                // Switch content
                const target = tab.getAttribute("data-target");
                contents.forEach((content) => {
                    content.classList.remove("show");
                });
                document.getElementById(target).classList.add("show");
            });
        });


        // ==========   FOR DRAWING A SIGNATURE IMAGE =================
        let canvas = document.getElementById("signature-pad");
        let signaturePad = new SignaturePad(canvas);

        function clearSignature() {
            signaturePad.clear();
        }

        function saveSignature() {
            if (signaturePad.isEmpty()) {
                alert("Please provide a signature.");
                return;
            }

            const dataUrl = signaturePad.toDataURL("image/png"); // Base64 PNG
            document.getElementById("SignatureData").value = dataUrl;

            // Submit the form
            document.getElementById("signatureForm").submit();
        }
            // ===========================================================

            document.addEventListener('DOMContentLoaded', function () {
                const InputFile = document.getElementById('fileInput');
                const uploadbtn = document.getElementById('uploadBtn');
                const savebtn = document.getElementById('saveBtn');

                const previewContainer = document.getElementById('previewContainer');
                const previewImage = document.getElementById('previewImage');

                // Handle Upload button Click
                uploadbtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    InputFile.click();
                });

                // Handle Functional of File Input Upload
                InputFile.addEventListener('change', function (e) {
                    e.preventDefault();
                    //Check if the Image data exist
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];

                        // Check the file size (Max 1 MB)
                        if (file.size > 1024 * 1024) {
                            alert('File size exceeds 1MB limit');
                            return;
                        }
                        // Check file Type
                        const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/bmp', 'image/gif'];

                        if (!validTypes.includes(file.type)) {
                            alert("Invalid file type, Please upload a png, jpeg, bmp or gif file");
                            return;
                        }

                        //Create a Preview Image When the Upload the file
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            previewImage.src = e.target.result;
                            previewContainer.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                });


                // handle save button click
                savebtn.addEventListener('click', function (e) {
                    e.preventDefault();

                    //validate the form
                    if (!InputFile.files || InputFile.files.length === 0) {
                        alert("Please upload an image of your signature before saving");
                        return;
                    }


                    const formData = new FormData();
                    formData.append('SignatureImage', InputFile.files[0]);
                    formData.append('UserID', strPIC);

                    const data = Object.fromEntries(formData);

                    $.ajax({
                        url:  '@Url.Action("UploadSignature", "Patrol")',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (res) {
                            if (res && res.success) {
                                placeholder.style.display = 'none';
                                signatureImage.style.display = 'block';
                                signatureInput.style.display = 'none';
                                signatureImage.src = '/User/GetSignatureImage?filename=' + encodeURIComponent(res.Data);
                                clearSignature();
                                $("#uploadmodal").modal("hide");
                            }
                        },
                        error: function (xhr, status, error) {
                            //$('#signatureImageError').text('An error occurred: ' + error);
                        },
                        complete: function () {
                            //saveBtn.prop('disabled', false).text('Save');
                        }
                    });

                    // Reset the form


                });
            });



        $("#SignatureForms").on('submit', async (e) => {
                      e.preventDefault();
                      const formData = new FormData(e.target);
                      const dataUrl = signaturePad.toDataURL("image/png"); // Base64 PNG
                      //document.getElementById("SignatureData").value = dataUrl;


                      //formData.append('SignatureImage', dataUrl);
                      //formData.append('UserID', selectedInspector);

                      const data = Object.fromEntries(formData);

                      fetch(dataUrl)
                          .then(res => res.blob())
                          .then(blob => {
                              const timestamp = Date.now(); // e.g., 1721705540000
                              const fileName = `Patrol_${timestamp}.png`;

                              const formData = new FormData();
                              const file = new File([blob], fileName, { type: "image/png" });

                              formData.append("SignatureImage", file); // Simulates <input type="file" />
                              formData.append("UserID", strPIC);
                              const data = Object.fromEntries(formData);

                              $.ajax({
                                  url:  '@Url.Action("UploadSignature", "Patrol")',
                                  type: 'POST',
                                  data: formData,
                                  processData: false,
                                  contentType: false,
                                  success: function (res) {
                                      if (res && res.success) {
                                          placeholder.style.display = 'none';
                                          signatureImage.style.display = 'block';
                                          signatureInput.style.display = 'none';
                                          signatureImage.src = '/User/GetSignatureImage?filename=' + encodeURIComponent(res.Data);
                                          clearSignature();
                                          $("#uploadmodal").modal("hide");
                                      }
                                  },
                                  error: function (xhr, status, error) {
                                      //$('#signatureImageError').text('An error occurred: ' + error);
                                  },
                                  complete: function () {
                                      //saveBtn.prop('disabled', false).text('Save');
                                  }
                              });
                          });
                  });
    </script>
</body>

