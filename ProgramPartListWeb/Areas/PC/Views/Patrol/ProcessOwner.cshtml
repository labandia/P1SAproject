
@{
    Layout = null;
    var regno = Request.QueryString["Regno"];
}

<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="@Url.Content("~/Content/Images/patrol .ico")">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>@ViewBag.Title</title>
    <link rel="preload" href="~/Content/fonts/Poppins-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">


    <script src="~/Scripts/bootstrap.bundle.min.js"></script>
    <link href="~/Content/css/RegistrationUI.css" rel="stylesheet" />

    @Styles.Render("~/Content/shared-css")

    @Scripts.Render("~/bundles/shared-js")
    @Scripts.Render("~/bundles/modernizr")
</head>


<body>
    <div class="MainWrapper">

        <div class="sidebar">
            <h2><i>📄</i><span id="regtext"></span></h2>
            <ul class="step-list">
                <li class="step-item active" data-step="1">
                    <span class="step-number">1</span>
                    Create new
                </li>
                <li class="step-item" data-step="2">
                    <span class="step-number">2</span>
                    Process Owner
                </li>
                <li class="step-item" data-step="3">
                    <span class="step-number">3</span>
                    Inspectors
                </li>
                <li class="step-item" data-step="4">
                    <span class="step-number">4</span>
                    Managers
                </li>
                <li class="step-item" data-step="5">
                    <span class="step-number">5</span>
                    Department Manager
                </li>
                <li class="step-item" data-step="6">
                    <span class="step-number">6</span>
                    Division Manager
                </li>
                <li class="step-item" data-step="7">
                    <span class="step-number">7</span>
                    View Form
                </li>
            </ul>
            </ul>
        </div>

        <div class="content">
            

            <!-- Step 1: Create New Document -->
            <div class="step-content active" id="step-1">

            </div>

            <!-- Step 2: Person in Charge -->
            <form method="post" enctype="multipart/form-data" class="step-content active" style="padding: 1.5em 0;" id="step-2" autocomplete="off">
                


                <div class="row mb-3">
                    <div class="col">
                        <label>Registration No.  </label> <br />
                        <input type="text" id="RegNo" value="@regno" name="RegNo" readonly />
                    </div>
                    <div class="col">
                        <label>Department / Section  </label> <br />
                        <input type="text" id="SectionName"  readonly />
                    </div>
                </div>


                <hr />


                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>1. Work Practice / Standard / Safety</label> <br />

                    <p id="Inpects1"></p>


                    <textarea placeholder="Type text here..." name="counter1" id="counter1" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>2. Identification and status of the product or materials.</label> <br />
                    <p id="Inpects2"></p>
                    <textarea placeholder="Type text here..." name="counter2" id="counter2" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>3. Condition and status of documents / records.</label> <br />
                    <p id="Inpects3"></p>
                    <textarea placeholder="Type text here..." name="counter3" id="counter3" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>4. Record of ‘start-up process check’ and monthly inspection</label> <br />
                    <p id="Inpects4"></p>
                    <textarea placeholder="Type text here..." name="counter4" id="counter4" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>5. Calibration of equipment and jigs used for measurement or inspection.</label> <br />
                    <p id="Inpects5"></p>
                    <textarea placeholder="Type text here..." name="counter5" id="counter5" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>6. Countermeasure and implementation of previous quality and safety</label> <br />
                    <p id="Inpects6"></p>
                    <textarea placeholder="Type text here..." name="counter6" id="counter6" rows="3" cols="40"></textarea>
                </div>



                <div class="row mb-3">
                    <div class="col">
                        <label>PIC Comments</label>
                        <textarea placeholder="Type text here..." name="PIC_Comments" id="PIC_Comments" rows="3" cols="40"></textarea>
                    </div>

                    <div class="col">
                        <label>Select Inspectors</label> <br />
                        <select id="Employee_ID" name="Employee_ID" class="mt-2" required>
                            <option value="14120005">Melo jean </option>
                            <option value="14030008">Lionell Gomez</option>
                        </select>
                    </div>
                </div>

                <div class="Attachmentcontainer col-12 col-sm-12 col-lg-12 mb-3">
                    <label class="mb-2 mt-2 fw-bold">Attachments : </label><br />


                    <div class="file-upload" id="file-upload-area">
                        <p>Click to upload files or drag and drop</p>
                        <input type="file" id="file-input" multiple style="display: none;">
                    </div>

                    <section class="flex_align mt-3">
                        <div id="fileContainer"></div>
                        <ul id="fileList" class="file-list"></ul>
                    </section>
                </div>

                <hr />

                <div class="button-group">
                    <div></div> <!-- Empty div for spacing -->
                    <button class="btn-next" type="submit" id="btnSave">Save & Send</button>
                </div>
            </form>

            <!-- Step 3: Document Details -->
            <div class="step-content" id="step-3">
                
            </div>

            <!-- Step 4: Attachments -->
            <div class="step-content" id="step-4">
               
            </div>

            <!-- Step 5: Review & Submit -->
            <div class="step-content" id="step-5">
                
            </div>
        </div>


    </div>


    <script type="text/javascript">
        let currentStep = 2;
        const totalSteps = 5;
        let selectedFiles = [];

        let strRegno = $("#RegNo").val();

        // =======  FOR UPLOADING FILES =======================
        const fileUploadArea = document.getElementById("file-upload-area");
        const fileList = document.getElementById("fileList");
        const fileInput = document.getElementById("file-input");
        // ====================================================

        const addform = document.getElementById("step-2");

        function goToStep(step) {
            // Update current step
            currentStep = step;


            // Update sidebar step states
            document.querySelectorAll('.step-item').forEach((item, index) => {
                const stepNumber = index + 1;

                // Completed (previous steps)
                if (stepNumber < step) {
                    item.classList.add('completed');
                    item.classList.remove('active', 'disabled');
                }
                // Active (current step)
                else if (stepNumber === step) {
                    item.classList.add('active');
                    item.classList.remove('completed', 'disabled');
                }
                // Locked (future steps)
                else {
                    item.classList.add('disabled');
                    item.classList.remove('active', 'completed');
                }
            });


            // Show/hide step content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step-${step}`).classList.add('active');
        }

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function () {
            goToStep(2);

            // Add click event to sidebar steps
            document.querySelectorAll('.step-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    return;
                });
            });
        });


        const findingsJson = (e) => {
            let formData = new FormData(e);
            const data = Object.fromEntries(formData);

            const findings = [];

            for (let i = 1; i <= 6; i++) {
                findings.push({
                    RegNo: strRegno,
                    FindID: i,
                    Countermeasure: data[`counter${i}`]
                });
            }


            return JSON.stringify(findings);
        };


         addform.addEventListener('submit', async (e) => {
             e.preventDefault();

                 // Get the ID of the save button and Store original text
                 const savebtn = document.querySelector("#btnSave");
                 const originalText = savebtn.innerHTML;

                 // Create loading icon and message container
                 savebtn.disabled = true;
                 savebtn.innerHTML = `<div class='buttonloading'></div><span id='loadingSequence'>Saving data...</span>`;

                 // Append form data
                 let strfind = findingsJson(e.target);
                 let finalformData = new FormData(e.target);
                 finalformData.append('FindJson', strfind);
                 // ✅ Add multiple attachments
                 selectedFiles.forEach(file => {
                     finalformData.append("Attachments", file);
                 });

                 // For registration validation, read RegNo from form data
                 const finaldata = Object.fromEntries(finalformData);

                 // Step 1: Simulate "Saving data..."
                 await new Promise(resolve => setTimeout(resolve, 1200)); // 1.2s delay for animation

                 // Step 2: Update loading text
                 document.querySelector("#loadingSequence").textContent = "Sending email to the inspector...";
                 await new Promise(resolve => setTimeout(resolve, 1200));

                 // Step 3: Send data to the controller
                 let res = await postData('@Url.Action("ProcessOwnerSubmission", "Patrol")', finalformData);

                 if (res && res.Success) {
                     document.querySelector("#loadingSequence").textContent = "Done ✅";
                     await new Promise(resolve => setTimeout(resolve, 1000));
                     savebtn.innerHTML = originalText;
                 } else {
                     // Reset button if failed
                     document.querySelector("#loadingSequence").textContent = "Failed. Please try again.";
                     await new Promise(resolve => setTimeout(resolve, 2000));
                     savebtn.innerHTML = originalText;
                     savebtn.disabled = false;
                 }

         });



        fileUploadArea.addEventListener("click", () => fileInput.click());
        // =================== MULTIPLE UPLOAD FILES ==============================
        fileInput.addEventListener("change", function () {
            // Add new files to the array (avoid duplicates by name+size)
            for (let file of fileInput.files) {
                let exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    selectedFiles.push(file);
                }
            }
            renderFileList();
            fileInput.value = ""; // reset input to allow re-upload of same file
        });


        function renderFileList() {
            fileList.innerHTML = "";
            selectedFiles.forEach((file, index) => {
                const div = document.createElement("div");
                div.classList.add("pdf-container");

                const pdfBtn = document.createElement("button");
                pdfBtn.classList.add("open-pdf-btn");
                pdfBtn.innerHTML = `<i class="fa-solid fa-file-pdf"></i> ${file.name}`;
                pdfBtn.onclick = () => {
                    const fileURL = URL.createObjectURL(file);
                    window.open(fileURL, "_blank");
                };

                const removeBtn = document.createElement("button");
                removeBtn.classList.add("remove-btn");
                removeBtn.innerHTML = `<i class="fa-regular fa-circle-xmark"></i>`;
                removeBtn.onclick = () => {
                    selectedFiles.splice(index, 1);
                    renderFileList();
                };

                div.appendChild(pdfBtn);
                div.appendChild(removeBtn);
                fileList.appendChild(div);
            });
        }

        const GetRegistrationDetails = async () => {
            let res = await FetchAuthenticate('@Url.Action("GetRegistrationNoDetails", "Patrol")', { Regno: strRegno });
            if (res && res.Success) {
                $("#regtext").text(strRegno);
                $("#SectionName").val("P1SA-" + res.Data.SectionName);
            }
        }

        const GetRegistrationID = async () => {
            let res = await FetchAuthenticate('@Url.Action("GetRegistrationFindings", "Patrol")', { Regno: strRegno });


            if (res && res.Success) {
                res.Data.forEach(item => {
                    $(`#Inpects${item.FindID}`).text("- " + item.FindDescription);
                });
            }
        }

        GetRegistrationDetails();
        GetRegistrationID();
    </script>
</body>

