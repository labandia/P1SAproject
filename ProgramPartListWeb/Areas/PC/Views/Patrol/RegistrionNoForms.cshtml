
@{
    Layout = null;
}

<head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/x-icon" href="@Url.Content("~/Content/Images/patrol .ico")">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>@ViewBag.Title</title>
    <link rel="preload" href="~/Content/fonts/Poppins-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">


    <script src="~/Scripts/bootstrap.bundle.min.js"></script>
    <link href="~/Content/css/RegistrationUI.css" rel="stylesheet" />

    @Styles.Render("~/Content/shared-css")

    @Scripts.Render("~/bundles/shared-js")
    @Scripts.Render("~/bundles/modernizr")
</head>


<body>
    <div class="MainWrapper">

        <div class="sidebar">
            <h2><i>📄</i> Registration No. </h2>
            <ul class="step-list">
                <li class="step-item active" data-step="1">
                    <span class="step-number">1</span>
                    Create new
                </li>
                <li class="step-item" data-step="2">
                    <span class="step-number">2</span>
                    Process Owner
                </li>
                <li class="step-item" data-step="3">
                    <span class="step-number">3</span>
                    Inspector
                </li>
                <li class="step-item" data-step="4">
                    <span class="step-number">4</span>
                    Managers
                </li>
                @*<li class="step-item" data-step="5">
                        <span class="step-number">5</span>
                        Department Managerss
                    </li>*@
                <li class="step-item" data-step="5">
                    <span class="step-number">5</span>
                    Division Manager
                </li>
                <li class="step-item" data-step="6">
                    <span class="step-number">6</span>
                    Completed
                </li>
            </ul>
        </div>

        <div class="content">
           
            <!-- Step 1: Create New Document -->
            <form method="post" enctype="multipart/form-data" class="step-content active" id="step-1" autocomplete="off">
                <div class="flex_align mb-4">
                    <a class="Backbtn" href="/PC/Patrol/PatrolReport"><i class="fa-solid fa-arrow-left"></i></a>
                    <h3 class="mb-0">Create New Registration No.</h3>
                </div>



                <div class="row mb-3">
                    <div class="col-12 col-sm-12 col-lg-4">
                        <label>Registration No. <small style="color: #a81818; font-weight: 600;">*</small> </label> <br />
                        @*<input type="text" placeholder="Type Registration No." name="RegNo" id="RegNo" required />*@
                        <div class="date-wrapper">
                            <span class="prefix" id="prefix">@ViewBag.Prefix-</span>
                            <input name="RegNo" id="RegNo" class="styled-date" type="text" placeholder="YYMMDD" readonly required>

                            <div class="calendar-icon-wrapper">
                                <i class="fa-regular fa-calendar-days calendar-icon"></i>
                                <input type="date" class="real-date-input" id="hiddenDatePicker" onchange="formatAndDisplayDate(this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-sm-12 col-lg-4">
                        <label>Dept. /Section Inspected <small style="color: #a81818; font-weight: 600;">*</small> </label>
                        <div class="select-container">
                            <select id="DepartmentID" name="DepartmentID" required>
                                <option>-- Select Department --</option>
                                <option value="1">Molding</option>
                                <option value="2">Press</option>
                                <option value="3">Rotor</option>
                                <option value="4">Winding</option>
                                <option value="5">Circuit</option>
                            </select>
                        </div>

                    </div>

                    <div class="col-12 col-sm-12 col-lg-4 ">
                        <label>Person In Charge : </label> <br />
                        <div class="select-container">
                            <select id="Employee_ID" name="Employee_ID">
                            </select>
                        </div>
                    </div>
                </div>


                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>1. Work Practice / Standard / Safety</label> <br />
                    <input type="hidden" value="1" id="Find1" name="Find1" />
                    <textarea placeholder="Type text here..." name="Inpects1" id="Inpects1" rows="3" cols="40" required></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>2. Identification and status of the product or materials.</label> <br />
                    <input type="hidden" value="2" id="Find2" name="Find2" required />
                    <textarea placeholder="Type text here..." name="Inpects2" id="Inpects2" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>3. Condition and status of documents / records.</label> <br />
                    <input type="hidden" value="3" id="Find3" name="Find3" required />
                    <textarea placeholder="Type text here..." name="Inpects3" id="Inpects3" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>4. Record of ‘start-up process check’ and monthly inspection</label> <br />
                    <input type="hidden" value="4" id="Find4" name="Find4" required />
                    <textarea placeholder="Type text here..." name="Inpects4" id="Inpects4" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>5. Calibration of equipment and jigs used for measurement or inspection.</label> <br />
                    <input type="hidden" value="5" id="Find5" name="Find5" required />
                    <textarea placeholder="Type text here..." name="Inpects5" id="Inpects5" rows="3" cols="40"></textarea>
                </div>

                <div class="col-12 col-sm-12 col-lg-12 mb-3">
                    <label>6. Countermeasure and implementation of previous quality and safety</label> <br />
                    <input type="hidden" value="6" id="Find5" name="Find6" required />
                    <textarea placeholder="Type text here..." name="Inpects6" id="Inpects6" rows="3" cols="40"></textarea>
                </div>



                <div class="button-group">
                    <div>Your information is secure and encrypted</div> <!-- Empty div for spacing -->
                    <button class="btn-next" type="submit" id="btnSave">Next</button>
                </div>
            </form>

            <!-- Step 2: Person in Charge -->
            <div class="step-content" id="step-2">

            </div>

            <!-- Step 3: Document Details -->
            <div class="step-content" id="step-3">


                <!-- Step 4: Attachments -->
                <div class="step-content" id="step-4">

                </div>

                <!-- Step 5: Review & Submit -->
                <div class="step-content" id="step-5">

                </div>
            </div>


        </div>

    </div>



    <!-- Sequential Loader -->
    <div id="loader" class="loader-overlay">
        <div class="loader-box">
            <div class="loader-title">Generating Registration No...</div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
            </div>

            <div class="step-list">
                <div class="step" id="step1">
                    <div class="step-icon">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="step-contentloader">
                        <div class="step-title">Saving to the Database</div>
                        <div class="step-description">Storing your Registration data securely</div>
                    </div>
                </div>

                <div class="step" id="step2">
                    <div class="step-icon">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="step-contentloader">
                        <div class="step-title">Send Email to the Process Owner</div>
                        <div class="step-description">Notifying the review team</div>
                    </div>
                </div>

                <div class="step" id="step3">
                    <div class="step-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="step-contentloader">
                        <div class="step-title">Send Message Success</div>
                        <div class="step-description">Confirming submission completion</div>
                    </div>
                </div>

                <div class="step" id="step4">
                    <div class="step-icon">
                        <i class="fas fa-flag-checkered"></i>
                    </div>
                    <div class="step-contentloader">
                        <div class="step-title">Done and Close</div>
                        <div class="step-description">Process completed successfully</div>
                    </div>
                </div>
            </div>

            <button class="done-btn" id="doneBtn"><i class="fa-solid fa-check"></i> Done</button>
        </div>
    </div>







    <script type="text/javascript">
        let prefix = "@ViewBag.Prefix";
        let currentStep = 1;
        const totalSteps = 5;

        let regisTable = [];
        let emailTable = [];

        const addform = document.getElementById("step-1");


        function formatAndDisplayDate(value) {
            if (!value) return;
            const date = new Date(value);
            const yy = String(date.getFullYear()).slice(-2);
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            document.getElementById('RegNo').value = `${yy}${mm}${dd}`;
        }

        function goToStep(step) {
            // Update current step
            currentStep = step;

            // Update progress bar
            //const progressPercentage = ((step - 1) / (totalSteps - 1)) * 100;
            //document.querySelector('.progressV2').style.width = `${progressPercentage}%`;

            // Update sidebar steps
            document.querySelectorAll('.step-item').forEach((item, index) => {
                if (index + 1 < step) {
                    item.classList.add('completed');
                    item.classList.remove('active');
                } else if (index + 1 === step) {
                    item.classList.add('active');
                    item.classList.remove('completed');
                } else {
                    item.classList.remove('active', 'completed');
                }
            });

            // Show/hide step content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`step-${step}`).classList.add('active');
        }

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function () {
            goToStep(1);

            // Add click event to sidebar steps
            document.querySelectorAll('.step-item').forEach(item => {
                item.addEventListener('click', function () {
                    const step = parseInt(this.getAttribute('data-step'));
                    if (step < currentStep) {
                        goToStep(step);
                    }
                });
            });
        });

        const findingsJson = (e) => {
            let formData = new FormData(e);
            const data = Object.fromEntries(formData);

            const findings = [];

            for (let i = 1; i <= 6; i++) {
                findings.push({
                    RegNo: data.RegNo,
                    FindID: data[`Find${i}`],
                    FindDescription: data[`Inpects${i}`]
                });
            }

            return JSON.stringify(findings);
        };

          addform.addEventListener('submit', async (e) => {
                  e.preventDefault();

                  // Get the ID of the save button and Store original text
                  const savebtn = document.querySelector("#btnSave");
                  const originalText = savebtn.innerHTML;

                 // Create loading icon and message container
                 //savebtn.disabled = true;
                 //savebtn.innerHTML = `<div class='buttonloading'></div><span id='loadingSequence'>Saving data...</span>`;

                  // Append form data
                  let strfind = findingsJson(e.target);
                  let finalformData = new FormData(e.target);
                  finalformData.append('FindJson', strfind);

                  // For registration validation, read RegNo from form data
                  const finaldata = Object.fromEntries(finalformData);


                  let reg = prefix + "-" + finaldata.RegNo;

                   let checklist = regisTable.find(n => n.RegNo === reg);

                  if (checklist) {
                      Swal.fire({
                          icon: "error",
                          text: "Registration No is already inserted",
                          timer: 1500,
                          showConfirmButton: false
                      });

                      $("#errorvalid").show();
                      $("#labelguide").hide();
                      $("#RegNo").css("border", "1px solid red");
                      return;
                  }

                  // Show loader
                  document.getElementById('loader').classList.add('active');

                  // Reset steps
                  resetSteps();

                  let res = await postData('@Url.Action("AddRegistration", "Patrol")', finalformData);

                  if (res && res.Success) {
                      // Start the sequential loading process
                      startSequentialLoading();
                  } else {
                      // Reset button if failed
                      document.querySelector("#loadingSequence").textContent = "Failed. Please try again.";
                      await new Promise(resolve => setTimeout(resolve, 2000));
                  }

                  @*// Step 1: Simulate "Saving data..."
                  await new Promise(resolve => setTimeout(resolve, 1200)); // 1.2s delay for animation

                  // Step 2: Update loading text
                  document.querySelector("#loadingSequence").textContent = "Sending email to the Process Owner...";
                  await new Promise(resolve => setTimeout(resolve, 1200));

                  // Step 3: Send data to the controller
                  let res = await postData('@Url.Action("AddRegistration", "Patrol")', finalformData);

                  if (res && res.Success) {
                      document.querySelector("#loadingSequence").textContent = "Done ✅";
                      await new Promise(resolve => setTimeout(resolve, 1000));
                      savebtn.innerHTML = originalText;
                      window.location.href = "/PC/Patrol/PatrolReport";
                  } else {
                      // Reset button if failed
                      document.querySelector("#loadingSequence").textContent = "Failed. Please try again.";
                      await new Promise(resolve => setTimeout(resolve, 2000));
                      savebtn.innerHTML = originalText;
                      savebtn.disabled = false;
                  }*@


          });


        $("#DepartmentID").on('change', function (e) {
            e.preventDefault();
            let deptId = parseInt($(this).val());
            let filtered = emailTable.filter(res => res.Department_ID === deptId);

            let $employeeSelect = $("#Employee_ID");
            $employeeSelect.empty(); // clear old options

            if (filtered.length > 0) {

                // Add filtered employees
                filtered.forEach(emp => {
                    $employeeSelect.append(`<option value="${emp.Employee_ID}">${emp.FullName}</option>`);
                });
            } else {
                // No employees found
                $.each(emailTable, function (index, rowData) {
                    $employeeSelect.append('<option value="' + rowData.Employee_ID + '">' + rowData.FullName + '</option>');
                });
            }
        });





        function convertRegNoToDate(regNo) {
            if (!regNo || typeof regNo !== "string") return null;

            const match = regNo.match(/P1SA-(\d{6})/);
            if (!match) return null;

            const [yy, mm, dd] = [match[1].slice(0, 2), match[1].slice(2, 4), match[1].slice(4, 6)];
            const year = 2000 + parseInt(yy, 10);
            return `${year}-${mm}-${dd}`;
        }

        function disableUsedDates(regList) {
            // handle both object arrays and string arrays
            const usedDates = regList
                .map(x => convertRegNoToDate(x.RegNo || x)) // ✅ safe mapping
                .filter(Boolean); // remove nulls

            const dateInput = document.getElementById('hiddenDatePicker');
            dateInput.addEventListener('change', (e) => {
                const selectedDate = e.target.value;
                if (usedDates.includes(selectedDate)) {
                    Swal.fire({
                        icon: "error",
                        text: "Registration No is already inserted",
                        timer: 1500,
                        showConfirmButton: false
                    });
                    e.target.value = '';
                } else {
                    formatAndDisplayDate(selectedDate);
                }
            });
        }



        const RegistrationTable = async() => {
            let res = await fetchData('@Url.Action("GetRegistrationNo", "Patrol")', {});
            if (res && res.Success) {
                regisTable = res.Data;
                disableUsedDates(regisTable);
            }
        }
        const GetEmailList = async () => {
            let res = await fetchData('@Url.Action("GetEmaiRegistration", "Patrol")', {});
            if (res.Success) {
                let select = $("#Employee_ID");
                select.empty();

                emailTable = res.Data;

                $.each(emailTable, function (index, rowData) {
                    select.append('<option value="' + rowData.Employee_ID + '">' + rowData.FullName + '</option>');
                });
            }
        };



        // ############## DISPLAY ALL THE DATA TO THE PAGE ########################
        const LoadPageData = async () => {
            try {


                const [regist, email] = await Promise.all([
                    RegistrationTable(),
                    GetEmailList()
                ]);
            } catch (error) {
                console.error("Failed to load page data:", error);
            } finally {
                // Hide loading spinner whether success or failure
                //$("#loadingSpinner").hide();
            }
        }

        $(document).ready(() => {
            LoadPageData();
        });






        // Loading Submisstion Process

        function resetSteps() {
            const steps = document.querySelectorAll('.step');
            steps.forEach(step => {
                step.classList.remove('active', 'completed');
            });

            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '0%';
            document.getElementById('doneBtn').classList.remove('show');
        }

        function startSequentialLoading() {
            const steps = [
                { id: 'step1', duration: 2000, progress: 25 },
                { id: 'step2', duration: 2500, progress: 50 },
                { id: 'step3', duration: 1500, progress: 75 },
                { id: 'step4', duration: 1000, progress: 100 }
            ];

            let currentStep = 0;

            function processNextStep() {
                if (currentStep >= steps.length) {
                    // All steps completed
                    document.getElementById('doneBtn').classList.add('show');
                    return;
                }

                const step = steps[currentStep];
                const stepElement = document.getElementById(step.id);

                // Activate current step
                stepElement.classList.add('active');

                // Update progress
                document.getElementById('progressFill').style.width = step.progress + '%';
                document.getElementById('progressText').textContent = step.progress + '%';

                // Simulate processing time
                setTimeout(function () {
                    // Mark step as completed
                    stepElement.classList.remove('active');
                    stepElement.classList.add('completed');

                    // Move to next step
                    currentStep++;
                    processNextStep();
                }, step.duration);
            }

            // Start the sequence
            processNextStep();
        }


        document.getElementById('doneBtn').addEventListener('click', function () {
            // Hide loader
            document.getElementById('loader').classList.remove('active');


            window.location.href = "/PC/Patrol/PatrolReport";

        });
    </script>
</body>

