
@{
    Layout = "~/Areas/Rotor/Views/Shared/_RegisterLayout.cshtml";
}

<!-- GRID with only 2 columns -->
<main>
    <!-- FORMS INPUT HERE -->
    <aside>
        <div class="form-header">
            P1SA Registration No.
        </div>
        <form id="registrationForm">
            <div class="form-grid">

                <div class="form-group">
                    <label for="regNo"><i class="fas fa-hashtag"></i> Registration No</label>
                    <input type="text" id="regNo" name="RegistrationNo" placeholder="REG-00125" required>
                </div>

                <div class="form-group full-width">
                    <label for="description"><i class="fas fa-align-left"></i> Description</label>
                    <textarea id="description" name="Desciprtion" placeholder="Enter detailed description..." required></textarea>
                </div>

                <div class="form-group full-width">
                    <label for="remarks"><i class="fas fa-sticky-note"></i> Remarks</label>
                    <textarea id="remarks" name="Remarks" placeholder="Additional remarks or notes..."></textarea>
                </div>

                <div class="form-group">
                    <label for="category"><i class="fas fa-tag"></i> Category</label>
                    <select id="category" name="CategoryID" required>
                        <option value="">Select Category</option>
                        <option value="1">🟦 Quality</option>
                        <option value="2">🟩 Process</option>
                        <option value="3">🟥 Safety</option>
                        <option value="4">🟨 Maintenance</option>
                        <option value="5">🟪 Documentation</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="department"><i class="fas fa-building"></i> Department</label>
                    <select id="department" name="DepartmentID" required>
                        <option value="">Select Department</option>
                        <option value="1">Molding</option>
                        <option value="2">Press</option>
                        <option value="3">Rotor</option>
                        <option value="4">Winding</option>
                        <option value="5">Circuit</option>
                    </select>
                </div>


                <div class="footerform">
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-paper-plane"></i> Submit Registration
                    </button>
                </div>
            </div>
        </form>
    </aside>

    <!-- filters and Table only -->
    <section>
        <div class="controls">
            <div class="filters">
                <div class="filter-group">
                    <label for="searchInput"><i class="fas fa-search"></i> Search</label>
                    <input type="text" id="searchInput" placeholder="Search Here ...">
                </div>

                <div class="filter-group">
                    <label for="yearFilter"><i class="fas fa-calendar-alt"></i> Year  </label>
                    <select id="yearFilter" class="filter-select">
                        <!-- Years will be populated by JavaScript -->
                    </select>
                </div>
                <div class="filter-group">
                    <label for="monthFilter"><i class="fas fa-calendar"></i> Month</label>
                    <select id="monthFilter" class="filter-select">
                        <option value="all">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="categoryFilter"><i class="fas fa-tag"></i> Category</label>
                    <select id="categoryFilter" class="filter-select">
                        <option value="all">All Categories</option>
                        <option value="1">🟦 Quality</option>
                        <option value="2">🟩 Process</option>
                        <option value="3">🟥 Safety</option>
                        <option value="4">🟨 Maintenance</option>
                        <option value="5">🟪 Documentation</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="departmentFilter"><i class="fas fa-building"></i> Section</label>
                    <select id="departmentFilter" class="filter-select">
                        <option value="all">All Departments</option>
                        <option value="1">Molding</option>
                        <option value="2">Press</option>
                        <option value="3">Rotor</option>
                        <option value="4">Winding</option>
                        <option value="5">Circuit</option>
                    </select>
                </div>
            </div>
        </div>



        <div class="table-container" style="position: relative; height: 100%;">
            <!-- Loading Overlay -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>

            <div class="responsive-table">
                <table id="registrationTable">
                    <thead>
                        <tr>
                            <th>Registration No</th>
                            <th>Description</th>
                            <th>Remarks</th>
                            <th>Category</th>
                            <th>Section</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-inbox" style="transform: scale(2.5);"></i>
                <h3 style="margin: 1em 0 .5em;">No Registrations Found</h3>
                <p>Add your first Registration No using the form on the left.</p>
            </div>
        </div>
        <div class="pagination" id="pagination">
            <div class="legends">
                <div class="legend-item">
                    <div class="legend-color molding"></div>
                    <span>Quality</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color press"></div>
                    <span>Process</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color rotor"></div>
                    <span>Safety</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color winding"></div>
                    <span>Maintenance</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color circuit"></div>
                    <span>Documentation</span>
                </div>
            </div>
            <div class="pagination-items">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </section>
</main>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>




@*=================================================================================*@
@*=========================== ADD METAL MASK INFO ==================================*@
@*=================================================================================*@
<div class="modal fade modal-l" id="AddProductModal" tabindex="-1" role="dialog" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">

            <div class="modal-body modalwrap">
                <div class="custom_modal_header">
                    <h5>Edit Registration No</h5>

                    <button type="button" class="btn btn-light  close" data-bs-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>

     
                <form method="post" enctype="multipart/form-data" class="addformcontainer" id="addMaskform" autocomplete="off">
                    <input type="hidden" id="EditRegistrationID" name="RegistrationID" >
                    <input type="hidden" id="EditNewRegistrationNo" name="NewRegistrationNo" />
                    <div class="form-group">
                        <label for="regNo"><i class="fas fa-hashtag"></i> Registration No  <span id="errormessage" style="color: #a81818;"></span></label>
                        <input type="text" id="EditregNo" name="RegistrationNo" placeholder="REG-00125" required>
                    </div>

                    <div class="form-group full-width">
                        <label for="description"><i class="fas fa-align-left"></i> Description</label>
                        <textarea id="EditDesciprtion" name="Desciprtion" placeholder="Enter detailed description..." required></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label for="remarks"><i class="fas fa-sticky-note"></i> Remarks</label>
                        <textarea id="EditRemarks" name="remarks" placeholder="Additional remarks or notes..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="category"><i class="fas fa-tag"></i> Category</label>
                        <select id="Editcategory" name="CategoryID" required>
                            <option value="">Select Category</option>
                            <option value="1">🟦 Quality</option>
                            <option value="2">🟩 Process</option>
                            <option value="3">🟥 Safety</option>
                            <option value="4">🟨 Maintenance</option>
                            <option value="5">🟪 Documentation</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="department"><i class="fas fa-building"></i> Department</label>
                        <select id="Editdepartment" name="DepartmentID" required>
                            <option value="">Select Department</option>
                            <option value="1">Molding</option>
                            <option value="2">Press</option>
                            <option value="3">Rotor</option>
                            <option value="4">Winding</option>
                            <option value="5">Circuit</option>
                        </select>
                    </div>

                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div>
                            <small>All fields marked with (<small style="color: #a81818; font-weight: 600;">*</small>) must be filled out</small>
                        </div>
                        <button id="btnSave" class="primarybtn"><i class="fa-regular fa-floppy-disk"></i> Save</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>




<script>
    let setData = [];
    let debounceTimer;
    // Add pagination state variables
    let currentPage = 1;
    let totalRecords = 0;
    let totalPages = 0;
    const pageSize = 10; // Set your desired page size (8 or 10)



    const year = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;

    const registrationForm = document.getElementById('registrationForm');
    const loading = document.getElementById('loading');
    const toast = document.getElementById('toast');
    const editform = document.getElementById('addMaskform');
    const emptyState = document.getElementById('emptyState');
    let tableBody = $("#tableBody");

    const categories = {
        1: "Quality",
        2: "Process",
        3: "Safety",
        4: "Maintenance",
        5: "Documentation"
    };

    const departments = {
        1: "Molding",
        2: "Press",
        3: "Rotor",
        4: "Winding",
        5: "Circuit"
    };



    // ==== SEARCH FUNCTIONALITY =======
    $("#searchInput").on('keyup', debounce(() => {
        GetRegistrationData();
    }, 300));

    //// ==== FILER by month ===========
    $("#monthFilter").on("change", debounce(() => {
        GetRegistrationData();
    }, 300));

    //// ==== FILER by category ===========
    $("#categoryFilter").on("change", debounce(() => {
        GetRegistrationData();
    }, 300));

    //// ==== FILER by departnetb ===========
    $("#departmentFilter").on("change", debounce(() => {
        GetRegistrationData();
    }, 300));


    editform.addEventListener('submit', async function (e) {
        e.preventDefault();
        let formData = new FormData(e.target);
        const dat = Object.fromEntries(formData);
         let res = await postMethod('@Url.Action("EditRegistrationNo", "Register")', formData);
        if (res?.Success) {
            $("#errormessage").hide();
            showToast('Update Data successfully!');
            $("#AddProductModal").modal("hide");

            GetRegistrationData();
            // Reset form
            editform.reset();
        } else {
            $("#errormessage").show();
            $("#errormessage").text(`Registration No : ${dat.RegistrationNo} is already Input`)
        }
    });


    const GetRegistrationData = async () => {
        showLoading(true);
        tableBody.empty();

        // Reset dropdown initialization flag
        dropdownInitialized = false;

        let searchText = $("#searchInput").val();
        let filtermonth = $("#monthFilter").val() === "all" ? currentMonth : $("#monthFilter").val();
        let stryear = !$("#yearFilter").val() ? year : $("#yearFilter").val();
        let category = $("#categoryFilter").val() === "all" ? 0 : $("#categoryFilter").val();
        let depId = $("#departmentFilter").val() === "all" ? 0 : $("#departmentFilter").val();


          try {
              const url = '@Url.Action("GetRegistrationInformation", "Register")';

              let res = await GetMethod(url, {
                  search: searchText,
                  monthfilter: filtermonth,
                  yearint: stryear,
                  catID: category,
                  depID: depId, 
                  pageNumber: currentPage,
                  pageSize: pageSize      
              });

              console.log(res);
               if (res?.Success) {
                   //console.clear();
                    emptyState.style.display = 'none';

                   setData = res.data.Items;
                   totalRecords = res.data.TotalRecords || 0;
                   totalPages = Math.ceil(totalRecords / pageSize);
                   console.log("Total Recorrs : " + totalRecords + " Page Size : " + pageSize + "totalPages : " + totalPages);
                   if (setData.length === 0 && totalRecords > 0 && currentPage > 1) {
                       currentPage = totalPages;
                       GetRegistrationData(); 
                       return;
                   }


                    let html = "";

                   setTimeout(() => {
                       if (setData.length > 0) {
                           $.each(setData, function (index, row) {
                               // Simple dropdown with only Edit and Delete
                               const dropdownMenu = `
                                       <div class="dropdown">
                                           <button class="dropdown-btn" aria-label="Open menu">
                                               <i class="fas fa-ellipsis-v"></i>
                                           </button>
                                           <div class="dropdown-content">
                                               <a href="#" class="edit-action" data-id="${row.RegistrationID}">
                                                   <i class="fas fa-edit"></i> Edit
                                               </a>
                                               <a href="#" class="delete-action" data-id="${row.RegistrationID}">
                                                   <i class="fas fa-trash"></i> Delete
                                               </a>
                                           </div>
                                       </div>
                                   `;


                               // Image Display
                               html += `
                                     <tr class='cleanTable' data-id="${row.RegistrationID}">
                                           <td style='font-weight: 600;'>${row.RegistrationNo ? row.RegistrationNo : "-"}</td>
                                           <td >${row.Desciprtion ? row.Desciprtion : "-"} </td>
                                           <td >${row.Remarks ? row.Remarks : "-"}</td>
                                           <td><span class="category-badge ${categories[row.CategoryID]}">${row.CategoryID ? categories[row.CategoryID] : "-"}</span></td>
                                           <td><span class="department-badge ${departments[row.DepartmentID].toLowerCase()}">${departments[row.DepartmentID] || "-"}</span></td>
                                           <td class="actions-cell">
                                               ${dropdownMenu}
                                           </td>
                                     </tr>
                                 `;
                           });

                           tableBody.append(html);

                           // Initialize dropdown functionality
                           initDropdownActions();

                          

                           // Update pagination UI
                           updatePaginationUI();
                       } else {
                           emptyState.style.display = 'block';
                           // Hide pagination if no data
                           $("#pagination").hide();
                       }

                       showLoading(false);
                   }, 500);
               } else {
                   setTimeout(() => {
                       // handle specific error types

                       let errorMessage = res?.Message || 'No Data found';

                       if (res?.errorType === 'NotFoundError') {
                           errorMessage = 'Api endpoint not found. Please contact the Administrator';
                       } else if (res?.errorType === 'UnauthorizedError') {
                           errorMessage = 'Your Session Token is expired. please refresh the page';
                       }
                       emptyState.style.display = 'block';
                       $("#pagination").hide();
                       // Optional show a Toast
                       console.error("API Error : ", errorMessage, res);

                       showLoading(false);
                   }, 500);
               }
          } catch (error) {
              console.error('Unexpected error in GetMetalMaskTransaction:', error);
          }
    };

    const GetRegistrationYearData = async () => {
        const url = '@Url.Action("GetRegistrationList", "Register")';

        let res = await GetMethod(url, {});

        if (res?.Success) {
            let data = res.data;
            if (data.length > 0) {
                $.each(data, function (index, year) {
                    $("#yearFilter").append(`<option value='${year}'>${year}</option>`);
                });
            } else {
                $("#yearFilter").append(`<option value="${year}">${year}</option>`)
            }
        }
    };







    registrationForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        const formData = new FormData(e.target);

         let res = await postMethod('@Url.Action("AddNewRegistration", "Register")', formData);
         if (res?.Success) {
             GetRegistrationData();
             // Reset form
             registrationForm.reset();

             showToast('Registration added successfully!');
         }

    });



    function renderTable() {
        // SHOW LOADING INDICATOR
        showLoading(true);
    }

    // Show toast notification
    function showToast(message, type = 'success') {
        toast.textContent = message;
        toast.className = `toast ${type} show`;

        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Show loading state
    function showLoading(show = true) {
        loading.classList.toggle('active', show);

        // Update empty state
        //emptyState.style.display = filtered.length === 0 ? 'block' : 'none';
    }

    // Debounce function for search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // renderTable();

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("monthFilter").value = currentMonth;
    });


    // Initialize dropdown functionality - FIXED VERSION
    let dropdownInitialized = false;
        // Initialize dropdown functionality
    function initDropdownActions() {
        // Prevent multiple initializations
        if (dropdownInitialized) {
            return;
        }
        dropdownInitialized = true;

        console.log('Initializing dropdown actions...');

        // Use event delegation on document instead of document
        $(document)
            .off('click', '.dropdown-btn') // Remove previous handlers
            .on('click', '.dropdown-btn', function (e) {
                e.stopPropagation();
                e.preventDefault();
                console.log('Dropdown button clicked');

                const $dropdown = $(this).closest('.dropdown');
                const isActive = $dropdown.hasClass('active');

                // Close all other dropdowns
                $('.dropdown').removeClass('active');

                // Toggle current dropdown
                if (!isActive) {
                    $dropdown.addClass('active');
                }
            })
            .off('click', '.edit-action') // Remove previous handlers
            .on('click', '.edit-action', function (e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Edit action clicked');

                const registrationId = $(this).data('id');

                // Close dropdown
                $(this).closest('.dropdown').removeClass('active');

                // Call your edit function
                editRegistration(registrationId);
            })
            .off('click', '.delete-action') // Remove previous handlers
            .on('click', '.delete-action', function (e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Delete action clicked');

                const registrationId = $(this).data('id');
                const $row = $(this).closest('tr');

                // Close dropdown
                $(this).closest('.dropdown').removeClass('active');

                // Show confirmation dialog
                if (confirm('Are you sure you want to delete this registration?')) {
                    deleteRegistration(registrationId, $row);
                }
            });

        // Close dropdown when clicking outside
        $(document).on('click', function (e) {
            if (!$(e.target).closest('.dropdown').length) {
                $('.dropdown').removeClass('active');
            }
        });
    }

    // Edit function
    function editRegistration(id) {
        console.log('Opening edit form for ID:', id);
        let filterData = setData.find(res => res.RegistrationID === id);
        if (filterData) {
            $("#EditRegistrationID").val(id);
            $("#EditNewRegistrationNo").val(filterData.RegistrationNo);
            $("#EditregNo").val(filterData.RegistrationNo);
            $("#EditDesciprtion").val(filterData.Desciprtion);
            $("#EditRemarks").val(filterData.Remarks);
            $("#Editcategory").val(filterData.CategoryID);
            $("#Editdepartment").val(filterData.DepartmentID);
        }
        $("#AddProductModal").modal("show");
    }

    // Delete function
    async function deleteRegistration(id, $row) {
        console.log('Deleting registration with ID:', id);

        let res = await postMethod('@Url.Action("DeleteRegistrationNo", "Register")', { ID: id });
         if (res?.Success) {
             GetRegistrationData();

             showToast('Delete Data successfully!');
         }

    }

    // Optional: Add this to your document ready
    $(document).ready(function() {
        // Initialize if not already done
        if (typeof initDropdownActions === 'function') {
            // It will be initialized when data loads
        }
    });



    function updatePaginationUI() {
        console.log('updatePaginationUI called');
        console.log('Total records:', totalRecords, 'Total pages:', totalPages);

        const $pagination = $("#pagination");
        const $paginationItems = $(".pagination-items");

        // Clear existing buttons
        $paginationItems.empty();

        // Always show pagination for debugging
        $pagination.css({
            'display': 'flex',
            'visibility': 'visible',
            'opacity': '1',
            'position': 'relative'
        });

        // Show/hide based on total pages
        if (totalPages > 1) {
            console.log('Creating', totalPages, 'page buttons');

            for (let i = 1; i <= totalPages; i++) {
                const active = i === currentPage ? 'active' : '';
                $paginationItems.append(`
                <button class="page-btn ${active}" data-page="${i}">${i}</button>
            `);
            }

            // Add click handlers
            $(".page-btn").off('click').on('click', function () {
                const pageNum = parseInt($(this).data('page'));
                console.log('Page button clicked:', pageNum);
                if (pageNum !== currentPage) {
                    currentPage = pageNum;
                    GetRegistrationData();
                }
            });

            console.log('Pagination should be visible now');
        } else {
            console.log('Hiding pagination - only 1 page or less');
            $pagination.hide();
        }

        // Force redraw
        $pagination[0].offsetHeight;
    }


    GetRegistrationYearData();
    GetRegistrationData();
</script>