
@{
    Layout = "~/Areas/Rotor/Views/Shared/_RegisterLayout.cshtml";
}

<div class="RegisterContainer">
    <div class="controls">
        <div class="filters">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="Search by Registration No, Description or Remarks...">
            </div>
            <div class="filter-group">
                <label for="monthFilter">Filter by Month</label>
                <select id="monthFilter" class="filter-select">
                    <option value="0">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="categoryFilter">Category</label>
                <select id="categoryFilter" class="filter-select">
                    <option value="0">All Categories</option>
                    <option value="1">Quality</option>
                    <option value="2">Process</option>
                    <option value="3">Safety</option>
                    <option value="4">Maintenance</option>
                    <option value="5">Documentation</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="departmentFilter">Department</label>
                <select id="departmentFilter" class="filter-select">
                    <option value="0">All Departments</option>
                    <option value="1">Molding</option>
                    <option value="2">Press</option>
                    <option value="3">Rotor</option>
                    <option value="4">Winding</option>
                    <option value="5">Circuit</option>
                </select>
            </div>
        </div>
    </div>




    <div class="table-container">
        <div class="table-header">
            <h2>Registration Records</h2>
            <div class="table-actions">
                <button class="btn btn-outline" id="exportBtn">
                    <i class="fas fa-download"></i> Export
                </button>
                <button class="btn btn-primary" id="addBtn">
                    <i class="fas fa-plus"></i> Add Registration
                </button>
            </div>
        </div>

        <div class="responsive-table">
            <table id="registrationTable">
                <thead>
                    <tr>
                        <th>Date Created</th>
                        <th>Registration No</th>
                        <th>Description</th>
                        <th>Remarks</th>
                        <th>Department</th>
                    </tr>
                </thead>
                <tbody id="TransactionTable">
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination">
            <!-- Pagination will be generated by JavaScript -->
        </div>
    </div>

    <footer>
        <p>Registration Data Dashboard &copy; 2023 | Showing registration data with month filtering</p>
    </footer>
</div>



<script>
    let debounceTimer;

    // ==== SEARCH FUNCTIONALITY =======
    $("#searchInput").on('keyup', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            GetRegistrationData();
        }, 400);
    });

    // ==== FILER by month ===========
    $("#monthFilter").on("change", function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            GetRegistrationData();
        }, 400);
    });

    // ==== FILER by category ===========
    $("#categoryFilter").on("change", function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            GetRegistrationData();
        }, 400);
    });

    // ==== FILER by departnetb ===========
    $("#departmentFilter").on("change", function () {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            GetMetalMaskTensionCleaning();
        }, 400);
    });


    const GetRegistrationData = async () => {
        let searchText = $("#searchInput").val();
        let filtermonth = $("#monthFilter").val();
        let category = $("#categoryFilter").val();
        let depId = $("#departmentFilter").val();

          try {
               const url = '@Url.Action("GetRegistrationInformation", "Register")';

              let res = await GetMethod(url, {
                  search: searchText,
                  monthfilter: filtermonth,
                  catID: category,
                  depID: depId
              });

              console.log(res);

               if (res?.Success) {
                     console.clear();
                     let tableBody = $("#TransactionTable");
                     tableBody.empty();
                     setData = res.data.Items;
                     let html = "";

                    $.each(setData, function (index, row) {
                         // Image Display
                         html += `
                              <tr class='cleanTable' data-id="${row.RegistrationID}">
                                    <td style='font-weight: 600;'>${row.DateCreated ? row.DateCreated : "-"}</td>
                                    <td >${row.RegistrationNo ? row.RegistrationNo : "-"} </td>
                                    <td >${row.Desciprtion ? row.Desciprtion : "-"}</td>
                                    <td style='text-align: center;'>${row.Remarks ? row.Remarks : "-"}</td>
                                    <td >${row.DepartmentID ? row.DepartmentID : "-"}</td>

                              </tr>
                          `;
                     });

                     tableBody.append(html);
               } else {
                   // handle specific error types
                   let TableBody = $("#TransactionTable");
                   let errorMessage = res?.Message || 'No Data found';

                   if (res?.errorType === 'NotFoundError') {
                       errorMessage = 'Api endpoint not found. Please contact the Administrator';
                   } else if (res?.errorType === 'UnauthorizedError') {
                       errorMessage = 'Your Session Token is expired. please refresh the page';
                   }

                   TableBody.html(`<tr><td colspan="24" class="text-center text-danger">${errorMessage}</td></tr>`);

                   // Optional show a Toast
                   console.error("API Error : ", errorMessage, res);
               }
          } catch (error) {
              console.error('Unexpected error in GetMetalMaskTransaction:', error);
          }
    };



    GetRegistrationData();
</script>