
@{
    Layout = "~/Areas/Rotor/Views/Shared/_RegisterLayout.cshtml";
}

<!-- GRID with only 2 columns -->
<main>
    <!-- FORMS INPUT HERE -->
    <aside>
        <div class="form-header">
            P1SA Registration No.
        </div>
        <form id="registrationForm">
            <div class="form-grid">

                <div class="form-group">
                    <label for="regNo"><i class="fas fa-hashtag"></i> Registration No</label>
                    <input type="text" id="regNo" name="RegistrationNo" placeholder="REG-00125" required>
                </div>

                <div class="form-group full-width">
                    <label for="description"><i class="fas fa-align-left"></i> Description</label>
                    <textarea id="description" name="Desciprtion" placeholder="Enter detailed description..." required></textarea>
                </div>

                <div class="form-group full-width">
                    <label for="remarks"><i class="fas fa-sticky-note"></i> Remarks</label>
                    <textarea id="remarks" name="Remarks" placeholder="Additional remarks or notes..."></textarea>
                </div>

                <div class="form-group">
                    <label for="category"><i class="fas fa-tag"></i> Category</label>
                    <select id="category" name="CategoryID" required>
                        <option value="">Select Category</option>
                        <option value="1">🟦 Quality</option>
                        <option value="2">🟩 Process</option>
                        <option value="3">🟥 Safety</option>
                        <option value="4">🟨 Maintenance</option>
                        <option value="5">🟪 Documentation</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="department"><i class="fas fa-building"></i> Department</label>
                    <select id="department" name="DepartmentID" required>
                        <option value="">Select Department</option>
                        <option value="1">Molding</option>
                        <option value="2">Press</option>
                        <option value="3">Rotor</option>
                        <option value="4">Winding</option>
                        <option value="5">Circuit</option>
                    </select>
                </div>


                <div class="footerform">
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-paper-plane"></i> Submit Registration
                    </button>
                </div>
            </div>
        </form>
    </aside>

    <!-- filters and Table only -->
    <section>
        <div class="controls">
            <div class="filters">
                <div class="filter-group">
                    <label for="searchInput"><i class="fas fa-search"></i> Search</label>
                    <input type="text" id="searchInput" placeholder="Search Here ...">
                </div>

                <div class="filter-group">
                    <label for="yearFilter"><i class="fas fa-calendar-alt"></i> Year  </label>
                    <select id="yearFilter" class="filter-select">
                        <!-- Years will be populated by JavaScript -->
                    </select>
                </div>
                <div class="filter-group">
                    <label for="monthFilter"><i class="fas fa-calendar"></i> Month</label>
                    <select id="monthFilter" class="filter-select">
                        <option value="all">All Months</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="categoryFilter"><i class="fas fa-tag"></i> Category</label>
                    <select id="categoryFilter" class="filter-select">
                        <option value="all">All Categories</option>
                        <option value="1">🟦 Quality</option>
                        <option value="2">🟩 Process</option>
                        <option value="3">🟥 Safety</option>
                        <option value="4">🟨 Maintenance</option>
                        <option value="5">🟪 Documentation</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="departmentFilter"><i class="fas fa-building"></i> Section</label>
                    <select id="departmentFilter" class="filter-select">
                        <option value="all">All Departments</option>
                        <option value="1">Molding</option>
                        <option value="2">Press</option>
                        <option value="3">Rotor</option>
                        <option value="4">Winding</option>
                        <option value="5">Circuit</option>
                    </select>
                </div>
            </div>
        </div>



        <div class="table-container" style="position: relative; height: 100%;">
            <!-- Loading Overlay -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
            </div>

            <div class="responsive-table">
                <table id="registrationTable">
                    <thead>
                        <tr>
                            <th>Registration No</th>
                            <th>Description</th>
                            <th>Remarks</th>
                            <th>Category</th>
                            <th>Section</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                      
                    </tbody>
                </table>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-inbox" style="transform: scale(2.5);"></i>
                <h3 style="margin: 1em 0 .5em;">No Registrations Found</h3>
                <p>Add your first Registration No using the form on the left.</p>
            </div>
        </div>
        <div class="pagination" id="pagination">
            <div class="legends">
                <div class="legend-item">
                    <div class="legend-color molding"></div>
                    <span>Quality</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color press"></div>
                    <span>Process</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color rotor"></div>
                    <span>Safety</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color winding"></div>
                    <span>Maintenance</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color circuit"></div>
                    <span>Documentation</span>
                </div>
            </div>
            <div class="pagination-items">
                <button class="active">1</button>
                <button>2</button>
                <button>3</button>
                <button>4</button>
                <button>5</button>
            </div>
        </div>
    </section>
</main>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>


<script>
    let debounceTimer;
    const year = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1;
    const emptyState = document.getElementById('emptyState');

    // Sample data based on the provided SQL structure
    const categories = {
        1: "Quality",
        2: "Process",
        3: "Safety",
        4: "Maintenance",
        5: "Documentation"
    };

    const departments = {
        1: "Molding",
        2: "Press",
        3: "Rotor",
        4: "Winding",
        5: "Circuit"
    };



    // ==== SEARCH FUNCTIONALITY =======
    $("#searchInput").on('keyup', debounce(() => {
        GetRegistrationData();
    }, 300));

    //// ==== FILER by month ===========
    $("#monthFilter").on("change", debounce(() => {
        GetRegistrationData();
    }, 300));

    //// ==== FILER by category ===========
    $("#categoryFilter").on("change", debounce(() => {
        GetRegistrationData();
    }, 300));

    //// ==== FILER by departnetb ===========
    $("#departmentFilter").on("change", debounce(() => {
        GetRegistrationData();
    }, 300));


    const GetRegistrationData = async () => {
        showLoading(true);
        let tableBody = $("#tableBody");
        tableBody.empty();
        let searchText = $("#searchInput").val();
        let filtermonth = $("#monthFilter").val() === "all" ? currentMonth : $("#monthFilter").val();
        let stryear = !$("#yearFilter").val() ? year : $("#yearFilter").val();
        let category = $("#categoryFilter").val() === "all" ? 0 : $("#categoryFilter").val();
        let depId = $("#departmentFilter").val() === "all" ? 0 : $("#departmentFilter").val();


          try {
              const url = '@Url.Action("GetRegistrationInformation", "Register")';

              let res = await GetMethod(url, {
                  search: searchText,
                  monthfilter: filtermonth,
                  yearint: stryear,
                  catID: category,
                  depID: depId
              });


               if (res?.Success) {
                   console.clear();
                    emptyState.style.display = 'none';

                     setData = res.data.Items;
                     let html = "";

                   setTimeout(() => {
                       $.each(setData, function (index, row) {
                           // Image Display
                           html += `
                              <tr class='cleanTable' data-id="${row.RegistrationID}">
                                    <td style='font-weight: 600;'>${row.RegistrationNo ? row.RegistrationNo : "-"}</td>
                                    <td >${row.Desciprtion ? row.Desciprtion : "-"} </td>
                                    <td >${row.Remarks ? row.Remarks : "-"}</td>
                                     <td><span class="category-badge ${categories[row.CategoryID]}">${row.CategoryID ? categories[row.CategoryID] : "-"}</span></td>
                                     <td><span class="department-badge ${departments[row.DepartmentID].toLowerCase()}">Press</span></td>
                              </tr>
                          `;
                       });

                       tableBody.append(html);

                       showLoading(false);
                   }, 500);
               } else {
                   setTimeout(() => {
                       // handle specific error types

                       let errorMessage = res?.Message || 'No Data found';

                       if (res?.errorType === 'NotFoundError') {
                           errorMessage = 'Api endpoint not found. Please contact the Administrator';
                       } else if (res?.errorType === 'UnauthorizedError') {
                           errorMessage = 'Your Session Token is expired. please refresh the page';
                       }
                       emptyState.style.display = 'block';

                       // Optional show a Toast
                       console.error("API Error : ", errorMessage, res);

                       showLoading(false);
                   }, 500);
               }
          } catch (error) {
              console.error('Unexpected error in GetMetalMaskTransaction:', error);
          }
    };

    const GetRegistrationYearData = async () => {
        const url = '@Url.Action("GetRegistrationList", "Register")';

        let res = await GetMethod(url, {});

        if (res?.Success) {
            let data = res.data;
            if (data.length > 0) {
                $.each(data, function (index, year) {
                    $("#yearFilter").append(`<option value='${year}'>${year}</option>`);
                });
            } else {
                $("#yearFilter").append(`<option value="${year}">${year}</option>`)
            }
        }
    };





    const registrationForm = document.getElementById('registrationForm');
    const loading = document.getElementById('loading');
    const toast = document.getElementById('toast');


    registrationForm.addEventListener('submit', async function (e) {
        e.preventDefault();
        const formData = new FormData(e.target);

         let res = await postMethod('@Url.Action("AddNewRegistration", "Register")', formData);
         if (res?.Success) {
             GetRegistrationData();
             // Reset form
             registrationForm.reset();

             showToast('Registration added successfully!');
         }

    });



    function renderTable() {
        // SHOW LOADING INDICATOR
        showLoading(true);
    }

    // Show toast notification
    function showToast(message, type = 'success') {
        toast.textContent = message;
        toast.className = `toast ${type} show`;

        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Show loading state
    function showLoading(show = true) {
        loading.classList.toggle('active', show);

        // Update empty state
        //emptyState.style.display = filtered.length === 0 ? 'block' : 'none';
    }

    // Debounce function for search
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // renderTable();

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("monthFilter").value = currentMonth;
    });


    GetRegistrationYearData();
    GetRegistrationData();
</script>